/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.ui.commons.ListBox");jQuery.sap.require("sap.ui.commons.library");jQuery.sap.require("sap.ui.core.Control");sap.ui.core.Control.extend("sap.ui.commons.ListBox",{metadata:{publicMethods:["getSelectedIndex","setSelectedIndex","addSelectedIndex","removeSelectedIndex","getSelectedIndices","setSelectedIndices","addSelectedIndices","isIndexSelected","getSelectedItem","getSelectedItems","clearSelection","scrollToIndex","setItems","setSelectedKeys","getSelectedKeys"],library:"sap.ui.commons",properties:{"editable":{type:"boolean",group:"Behavior",defaultValue:true},"enabled":{type:"boolean",group:"Behavior",defaultValue:true},"allowMultiSelect":{type:"boolean",group:"Behavior",defaultValue:false},"visible":{type:"boolean",group:"Appearance",defaultValue:true},"width":{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},"height":{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},"scrollTop":{type:"int",group:"Behavior",defaultValue:-1},"displayIcons":{type:"boolean",group:"Behavior",defaultValue:false},"displaySecondaryValues":{type:"boolean",group:"Misc",defaultValue:false},"valueTextAlign":{type:"sap.ui.core.TextAlign",group:"Appearance",defaultValue:sap.ui.core.TextAlign.Begin},"secondaryValueTextAlign":{type:"sap.ui.core.TextAlign",group:"Appearance",defaultValue:sap.ui.core.TextAlign.Begin},"minWidth":{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},"maxWidth":{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},"visibleItems":{type:"int",group:"Dimension",defaultValue:null}},defaultAggregation:"items",aggregations:{"items":{type:"sap.ui.core.Item",multiple:true,singularName:"item"}},events:{"select":{}}}});sap.ui.commons.ListBox.M_EVENTS={'select':'select'};jQuery.sap.require("sap.ui.core.delegate.ItemNavigation");jQuery.sap.require("jquery.sap.strings");
sap.ui.commons.ListBox.prototype.init=function(){this.allowTextSelection(false);if(!this._bHeightInItems){this._bHeightInItems=false;this._iVisibleItems=-1;}this._sTotalHeight=null;if(sap.ui.commons.ListBox._fItemHeight===undefined){sap.ui.commons.ListBox._fItemHeight=-1;}if(sap.ui.commons.ListBox._iBordersAndStuff===undefined){sap.ui.commons.ListBox._iBordersAndStuff=-1;}this._aSelectionMap=[];this._iLastDirectlySelectedIndex=-1;this._aActiveItems=null;};
sap.ui.commons.ListBox.prototype.onThemeChanged=function(){sap.ui.commons.ListBox._fItemHeight=-1;sap.ui.commons.ListBox._iBordersAndStuff=-1;this._sTotalHeight=null;if(!this._bHeightInItems){this._iVisibleItems=-1;}this.invalidate();this.rerender();};
sap.ui.commons.ListBox.prototype.onBeforeRendering=function(){this.getScrollTop();};
sap.ui.commons.ListBox.prototype.onAfterRendering=function(){var d=this.getDomRef();if(sap.ui.commons.ListBox._fItemHeight<0){var o=d.firstChild.firstChild;sap.ui.commons.ListBox._fItemHeight=o.offsetHeight;if(jQuery.browser.msie&&(document.documentMode==9||document.documentMode==10)){var c=document.defaultView.getComputedStyle(o.firstChild,"");var h=parseFloat(c.getPropertyValue("height").split("px")[0]);var p=parseFloat(c.getPropertyValue("padding-top").split("px")[0]);var a=parseFloat(c.getPropertyValue("padding-bottom").split("px")[0]);var b=parseFloat(c.getPropertyValue("border-top-width").split("px")[0]);var e=parseFloat(c.getPropertyValue("border-bottom-width").split("px")[0]);sap.ui.commons.ListBox._fItemHeight=h+p+a+b+e;}if(o.id==(this.getId()+"-dummyItem")){o.parentNode.removeChild(o);}}if(sap.ui.commons.ListBox._iBordersAndStuff==-1){var $=jQuery(this.getDomRef());var f=$.outerHeight();var g=$.height();sap.ui.commons.ListBox._iBordersAndStuff=f-g;}if(this._bHeightInItems){if(this._sTotalHeight==null){this._calcTotalHeight();d.style.height=this._sTotalHeight;}else{}}if(this._iVisibleItems=-1){this._updatePageSize();}var j=this.getFocusDomRef(),r=j.childNodes,k=[],l=this.getItems();this._aActiveItems=[];var m=this._aActiveItems;for(var i=0;i<r.length;i++){if(!(l[i]instanceof sap.ui.core.SeparatorItem)){m[k.length]=i;k.push(r[i]);}}if(!this.oItemNavigation){var n=(!this.getEnabled()||!this.getEditable());this.oItemNavigation=new sap.ui.core.delegate.ItemNavigation(null,null,n);this.oItemNavigation.attachEvent(sap.ui.core.delegate.ItemNavigation.Events.AfterFocus,this._handleAfterFocus,this);this.addDelegate(this.oItemNavigation);}this.oItemNavigation.setRootDomRef(j);this.oItemNavigation.setItemDomRefs(k);this.oItemNavigation.setCycling(false);this.oItemNavigation.setSelectedIndex(this._getNavigationIndexForRealIndex(this.getSelectedIndex()));this.oItemNavigation.setPageSize(this._iVisibleItems);if(this.oScrollToIndexRequest){this.scrollToIndex(this.oScrollToIndexRequest.iIndex,this.oScrollToIndexRequest.bLazy);}else{var s=this.getProperty("scrollTop");if(s>-1){d.scrollTop=s;}}var t=this;window.setTimeout(function(){if(t.oScrollToIndexRequest){t.scrollToIndex(t.oScrollToIndexRequest.iIndex,t.oScrollToIndexRequest.bLazy);t.oScrollToIndexRequest=null;}else{var s=t.getProperty("scrollTop");if(s>-1){d.scrollTop=s;}}},0);};
sap.ui.commons.ListBox.prototype._getNavigationIndexForRealIndex=function(a){var b=this.getItems();var n=a;for(var i=0;i<a;i++){if(b[i]instanceof sap.ui.core.SeparatorItem){n--;}}return n;};
sap.ui.commons.ListBox.prototype._updatePageSize=function(){var d=this.getDomRef();if(d){if(sap.ui.commons.ListBox._fItemHeight>0){this._iVisibleItems=Math.floor(d.clientHeight/sap.ui.commons.ListBox._fItemHeight);}else{}}};
sap.ui.commons.ListBox.prototype.scrollToIndex=function(i,l){var d=this.getDomRef();if(d){var o=jQuery.sap.byId(this.getId()+"-list").children("li[data-sap-ui-lbx-index="+i+"]");o=o.get(0);if(o){var s=o.offsetTop;if(!l){this.setScrollTop(s);}else{var c=d.scrollTop;var v=jQuery(d).height();if(c>=s){this.setScrollTop(s);}else if((s+sap.ui.commons.ListBox._fItemHeight)>(c+v)){this.setScrollTop(Math.ceil(s+sap.ui.commons.ListBox._fItemHeight-v));}else{}}}this.getScrollTop();}else{this.oScrollToIndexRequest={iIndex:i,bLazy:l};}return this;};
sap.ui.commons.ListBox.prototype.getVisibleItems=function(){return this._iVisibleItems;};
sap.ui.commons.ListBox.prototype.setVisibleItems=function(i){this.setProperty("visibleItems",i,true);this._bHeightInItems=true;this._iVisibleItems=i;this._sTotalHeight=null;var d=this.getDomRef();if(d){var f=d.firstChild?d.firstChild.firstChild:null;if(f||((sap.ui.commons.ListBox._fItemHeight>0)&&(sap.ui.commons.ListBox._iBordersAndStuff>0))){d.style.height=this._calcTotalHeight();}else{this.invalidate();}}if(this._sTotalHeight==null){}return this;};
sap.ui.commons.ListBox.prototype._calcTotalHeight=function(){var d=this._iVisibleItems*sap.ui.commons.ListBox._fItemHeight;this._sTotalHeight=(d+sap.ui.commons.ListBox._iBordersAndStuff)+"px";return this._sTotalHeight;};
sap.ui.commons.ListBox.prototype.setHeight=function(h){this._bHeightInItems=false;this._iVisibleItems=-1;var d=this.getDomRef();if(d){d.style.height=h;this._updatePageSize();if(this.oItemNavigation){this.oItemNavigation.setPageSize(this._iVisibleItems);}}this.setProperty("height",h,true);return this;};
sap.ui.commons.ListBox.prototype.setWidth=function(w){var d=this.getDomRef();if(d){d.style.width=w;}this.setProperty("width",w,true);return this;};
sap.ui.commons.ListBox.prototype.setScrollTop=function(s){var a=this.getDomRef();this.oScrollToIndexRequest=null;if(a){a.scrollTop=s;}this.setProperty("scrollTop",s,true);return this;};
sap.ui.commons.ListBox.prototype.getScrollTop=function(){var s=this.getDomRef();if(s){var a=s.scrollTop;this.setProperty("scrollTop",a,true);return a;}else{return this.getProperty("scrollTop");}};
sap.ui.commons.ListBox.prototype.onfocusin=function(e){if(jQuery.browser.msie&&((jQuery.browser.version=="7.0")||(jQuery.browser.version=="8.0"))&&(e.target!=this.getDomRef())&&(e.target.className!="sapUiLbxI")){var p=e.target.parentNode;if(jQuery(p).hasClass("sapUiLbxI")){p.focus();}}};
sap.ui.commons.ListBox.prototype.onclick=function(e){this._handleUserActivation(e);};
sap.ui.commons.ListBox.prototype.onsapspace=function(e){this._handleUserActivation(e);};
sap.ui.commons.ListBox.prototype.onsapspacemodifiers=sap.ui.commons.ListBox.prototype.onsapspace;sap.ui.commons.ListBox.prototype.onsapenter=sap.ui.commons.ListBox.prototype.onsapspace;sap.ui.commons.ListBox.prototype.onsapentermodifiers=sap.ui.commons.ListBox.prototype.onsapspace;
sap.ui.commons.ListBox.prototype._handleUserActivation=function(e){if(!this.getEnabled()||!this.getEditable()){return;}var s=e.target;if(s.id===""||jQuery.sap.endsWith(s.id,"-txt")){s=s.parentNode;if(s.id===""){s=s.parentNode;}}var a=jQuery(s).attr("data-sap-ui-lbx-index");if(typeof a=="string"&&a.length>0){var i=parseInt(a,10);var b=this.getItems();var o=b[i];if(b.length<=i){i=b.length-1;}if(i>=0&&i<b.length){if(o.getEnabled()&&!(o instanceof sap.ui.core.SeparatorItem)){if(e.ctrlKey||e.metaKey){this._handleUserActivationCtrl(i,o);}else{if(e.shiftKey){this.setSelectedIndices(this._getUserSelectionRange(i));this.fireSelect({id:this.getId(),selectedIndex:i,selectedIndices:this.getSelectedIndices(),selectedItem:o,sId:this.getId(),aSelectedIndices:this.getSelectedIndices()});this._iLastDirectlySelectedIndex=i;}else{this._handleUserActivationPlain(i,o);}}}}e.preventDefault();e.stopPropagation();}};
sap.ui.commons.ListBox.prototype._handleUserActivationPlain=function(i,o){this._iLastDirectlySelectedIndex=i;this.oItemNavigation.setSelectedIndex(this._getNavigationIndexForRealIndex(i));if(this.getSelectedIndex()!=i||this.getSelectedIndices().length>1){this.setSelectedIndex(i);this.fireSelect({id:this.getId(),selectedIndex:i,selectedIndices:this.getSelectedIndices(),selectedItem:o,sId:this.getId(),aSelectedIndices:this.getSelectedIndices()});}};
sap.ui.commons.ListBox.prototype._handleUserActivationCtrl=function(i,o){this._iLastDirectlySelectedIndex=i;this.oItemNavigation.setSelectedIndex(this._getNavigationIndexForRealIndex(i));if(this.isIndexSelected(i)){this.removeSelectedIndex(i);}else{this.addSelectedIndex(i);}this.fireSelect({id:this.getId(),selectedIndex:i,selectedIndices:this.getSelectedIndices(),selectedItem:o,sId:this.getId(),aSelectedIndices:this.getSelectedIndices()});};
sap.ui.commons.ListBox.prototype._getUserSelectionRange=function(a){if(this._iLastDirectlySelectedIndex==-1){return[];}var b=this.getItems();var r=[];if(this._iLastDirectlySelectedIndex<=a){for(var i=this._iLastDirectlySelectedIndex;i<=a;i++){if((i>-1)&&(b[i].getEnabled()&&!(b[i]instanceof sap.ui.core.SeparatorItem))){r.push(i);}}}else{for(var i=a;i<=this._iLastDirectlySelectedIndex;i++){if((i>-1)&&(b[i].getEnabled()&&!(b[i]instanceof sap.ui.core.SeparatorItem))){r.push(i);}}}return r;};
sap.ui.commons.ListBox.prototype.getSelectedIndex=function(){for(var i=0;i<this._aSelectionMap.length;i++){if(this._aSelectionMap[i]){return i;}}return-1;};
sap.ui.commons.ListBox.prototype.setSelectedIndex=function(s){if((s<-1)||(s>this._aSelectionMap.length-1)){return;}var a=this.getItems();if((s>-1)&&(!a[s].getEnabled()||(a[s]instanceof sap.ui.core.SeparatorItem))){return;}for(var i=0;i<this._aSelectionMap.length;i++){this._aSelectionMap[i]=false;}this._aSelectionMap[s]=true;if(this.oItemNavigation){this.oItemNavigation.setSelectedIndex(this._getNavigationIndexForRealIndex(s));}this.getRenderer().handleSelectionChanged(this);return this;};
sap.ui.commons.ListBox.prototype.addSelectedIndex=function(s){if(!this.getAllowMultiSelect()){this.setSelectedIndex(s);}if((s<-1)||(s>this._aSelectionMap.length-1)){return;}var i=this.getItems();if((s>-1)&&(!i[s].getEnabled()||(i[s]instanceof sap.ui.core.SeparatorItem))){return;}if(this._aSelectionMap[s]){return;}this._aSelectionMap[s]=true;this.getRenderer().handleSelectionChanged(this);return this;};
sap.ui.commons.ListBox.prototype.removeSelectedIndex=function(i){if((i<0)||(i>this._aSelectionMap.length-1)){return;}if(!this._aSelectionMap[i]){return;}this._aSelectionMap[i]=false;this.getRenderer().handleSelectionChanged(this);return this;};
sap.ui.commons.ListBox.prototype.clearSelection=function(){for(var i=0;i<this._aSelectionMap.length;i++){if(this._aSelectionMap[i]){this._aSelectionMap[i]=false;}}this._iLastDirectlySelectedIndex=-1;if(this.oItemNavigation){this.oItemNavigation.setSelectedIndex(-1);}this.getRenderer().handleSelectionChanged(this);return this;};
sap.ui.commons.ListBox.prototype.getSelectedIndices=function(){var r=[];for(var i=0;i<this._aSelectionMap.length;i++){if(this._aSelectionMap[i]){r.push(i);}}return r;};
sap.ui.commons.ListBox.prototype.setSelectedIndices=function(s){var a=[];var b=this.getItems();for(var i=0;i<s.length;i++){if((s[i]>-1)&&(s[i]<this._aSelectionMap.length)){if(b[s[i]].getEnabled()&&!(b[s[i]]instanceof sap.ui.core.SeparatorItem)){a.push(s[i]);}}}if(a.length>0){if(!this.getAllowMultiSelect()){a=[a[0]];}}for(var i=0;i<this._aSelectionMap.length;i++){this._aSelectionMap[i]=false;}for(var i=0;i<a.length;i++){this._aSelectionMap[a[i]]=true;}this.getRenderer().handleSelectionChanged(this);return this;};
sap.ui.commons.ListBox.prototype.addSelectedIndices=function(s){var a=[];var b=this.getItems();for(var i=0;i<s.length;i++){if((s[i]>-1)&&(s[i]<this._aSelectionMap.length)){if(b[s[i]].getEnabled()&&!(b[s[i]]instanceof sap.ui.core.SeparatorItem)){a.push(s[i]);}}}if(a.length>0){if(!this.getAllowMultiSelect()){a=[a[0]];}for(var i=0;i<a.length;i++){this._aSelectionMap[a[i]]=true;}this.getRenderer().handleSelectionChanged(this);}return this;};
sap.ui.commons.ListBox.prototype.isIndexSelected=function(i){if((i<-1)||(i>this._aSelectionMap.length-1)){return false;}return this._aSelectionMap[i];};
sap.ui.commons.ListBox.prototype.setSelectedKeys=function(s){var a=this.getItems();var k;var m={};for(var i=0;i<s.length;i++){if(k=s[i]){m[k]=true;}}var b=[];for(var j=0;j<a.length;j++){if((k=a[j].getKey())&&(m[k])){b.push(j);}}return this.setSelectedIndices(b);};
sap.ui.commons.ListBox.prototype.getSelectedKeys=function(){var a=this.getItems();var r=[];for(var i=0;i<this._aSelectionMap.length;i++){if(this._aSelectionMap[i]){r.push(a[i].getKey());}}return r;};
sap.ui.commons.ListBox.prototype.getSelectedItem=function(){var i=this.getSelectedIndex();if((i<0)||(i>=this._aSelectionMap.length)){return null;}return this.getItems()[i];};
sap.ui.commons.ListBox.prototype.getSelectedItems=function(){var a=this.getItems();var r=[];for(var i=0;i<this._aSelectionMap.length;i++){if(this._aSelectionMap[i]){r.push(a[i]);}}return r;};
sap.ui.commons.ListBox.prototype.setAllowMultiSelect=function(a){this.setProperty("allowMultiSelect",a);var o=false;var t=false;if(!a&&this._aSelectionMap){for(var i=0;i<this._aSelectionMap.length;i++){if(this._aSelectionMap[i]){if(!o){o=true;}else{this._aSelectionMap[i]=false;t=true;}}}}if(t){this.getRenderer().handleSelectionChanged(this);}return this;};
sap.ui.commons.ListBox.prototype._handleAfterFocus=function(c){var i=c.getParameter("index");i=((i!==undefined&&i>=0)?this._aActiveItems[i]:0);this.getRenderer().handleARIAActivedescendant(this,i);};
sap.ui.commons.ListBox.prototype.setItems=function(a,d){this.bNoItemsChangeEvent=true;if(d){this.destroyItems();}else{this.removeAllItems();}for(var i=0,l=a.length;i<l;i++){this.addItem(a[i]);}this.bNoItemsChangeEvent=undefined;this.fireEvent("itemsChanged");return this;};
sap.ui.commons.ListBox.prototype.addItem=function(i){this.addAggregation("items",i);if(!this._aSelectionMap){this._aSelectionMap=[];}this._aSelectionMap.push(false);if(!this.bNoItemsChangeEvent){this.fireEvent("itemsChanged");}return this;};
sap.ui.commons.ListBox.prototype.insertItem=function(i,a){if((a<0)||(a>this._aSelectionMap.length)){return;}this.insertAggregation("items",i,a);this._aSelectionMap.splice(a,0,false);this.invalidate();if(!this.bNoItemsChangeEvent){this.fireEvent("itemsChanged");}return this;};
sap.ui.commons.ListBox.prototype.removeItem=function(e){var i=e;if(typeof(e)=="string"){e=sap.ui.getCore().byId(e);}if(typeof(e)=="object"){i=this.indexOfItem(e);}if((i<0)||(i>this._aSelectionMap.length-1)){return;}var r=this.removeAggregation("items",i);this._aSelectionMap.splice(i,1);this.invalidate();if(!this.bNoItemsChangeEvent){this.fireEvent("itemsChanged");}return r;};
sap.ui.commons.ListBox.prototype.removeAllItems=function(){var r=this.removeAllAggregation("items");this._aSelectionMap=[];this.invalidate();if(!this.bNoItemsChangeEvent){this.fireEvent("itemsChanged");}return r;};
sap.ui.commons.ListBox.prototype.destroyItems=function(){var d=this.destroyAggregation("items");this._aSelectionMap=[];this.invalidate();if(!this.bNoItemsChangeEvent){this.fireEvent("itemsChanged");}return d;};
sap.ui.commons.ListBox.prototype.exit=function(){if(this.oItemNavigation){this.removeDelegate(this.oItemNavigation);this.oItemNavigation.destroy();}};
sap.ui.commons.ListBox.prototype.getFocusDomRef=function(){return jQuery.sap.domById(this.getId()+'-list');};
sap.ui.commons.ListBox.prototype.getIdForLabel=function(){return this.getId()+'-list';};
