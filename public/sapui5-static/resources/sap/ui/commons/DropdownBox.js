/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.ui.commons.DropdownBox");jQuery.sap.require("sap.ui.commons.library");jQuery.sap.require("sap.ui.commons.ComboBox");sap.ui.commons.ComboBox.extend("sap.ui.commons.DropdownBox",{metadata:{publicMethods:["clearHistory"],library:"sap.ui.commons",properties:{"searchHelpEnabled":{type:"boolean",group:"Behavior",defaultValue:false},"searchHelpText":{type:"string",group:"Appearance",defaultValue:null},"searchHelpAdditionalText":{type:"string",group:"Appearance",defaultValue:null},"searchHelpIcon":{type:"sap.ui.core.URI",group:"Appearance",defaultValue:null},"maxHistoryItems":{type:"int",group:"Behavior",defaultValue:5}},events:{"searchHelp":{}}}});sap.ui.commons.DropdownBox.M_EVENTS={'searchHelp':'searchHelp'};jQuery.sap.require("sap.ui.core.History");jQuery.sap.require("sap.ui.core.SeparatorItem");sap.ui.commons.DropdownBox.getMetadata()._mHiddenAggregations=sap.ui.commons.ComboBox.getMetadata()._mHiddenAggregations;
sap.ui.commons.DropdownBox.prototype.init=function(){sap.ui.commons.ComboBox.prototype.init.apply(this,arguments);this._oValueBeforePaste=null;this._oValueBeforeOpen=null;this.__aItems=null;this._iCursorPosBeforeBackspace=null;this._searchHelpItem=null;this._iItemsForHistory=10;this._oHistory=new sap.ui.core.History(this.getId());};
sap.ui.commons.DropdownBox.prototype.exit=function(){var s=this.getId()+"-h-",i;if(this._searchHelpItem){this._searchHelpItem[0].destroy();this._searchHelpItem[1].destroy();this._searchHelpItem=null;}sap.ui.commons.ComboBox.prototype.exit.apply(this,arguments);function r(a){var o=sap.ui.getCore().byId(a);o&&o.destroy();}for(var i=0;i<this.getMaxHistoryItems();i++){r(s+i);}if(this.__oSeparator){this.__oSeparator.destroy();this.__oSeparator=null;}this._oHistory=null;};
sap.ui.commons.DropdownBox.prototype.onAfterRendering=function(e){sap.ui.commons.ComboBox.prototype.onAfterRendering.apply(this,arguments);this.checkValueInItems();};
sap.ui.commons.DropdownBox.prototype.setListBox=function(l){var o=this._getListBox();if(o){o.detachEvent("itemsChanged",this._handleItemsChanged,this);}sap.ui.commons.ComboBox.prototype.setListBox.apply(this,arguments);if(l){l.attachEvent("itemsChanged",this._handleItemsChanged,this);}return this;};
sap.ui.commons.DropdownBox.prototype._getPrivateListBox=function(){var n=!this._oListBox;sap.ui.commons.ComboBox.prototype._getPrivateListBox.apply(this,arguments);if(n){this._oListBox.attachEvent("itemsChanged",this._handleItemsChanged,this);}return this._oListBox;};
sap.ui.commons.DropdownBox.prototype._handleItemsChanged=function(e){this.checkValueInItems();};
sap.ui.commons.DropdownBox.prototype.onclick=function(e){if(e.target!==this.getInputDomRef()){return sap.ui.commons.ComboBox.prototype.onclick.apply(this,arguments);}};
sap.ui.commons.DropdownBox.prototype.onmouseup=function(e){if(e.target==this.getF4ButtonDomRef()){return;}if(e.target===this.getInputDomRef()&&this.oPopup&&this.oPopup.isOpen()){jQuery.sap.delayedCall(0,this,"_updateSelection",[0]);}else{this._doSelect();}};
sap.ui.commons.DropdownBox.prototype.onsapshow=function(e){if(e.which===jQuery.sap.KeyCodes.F4&&this._searchHelpItem){this._close();this.fireSearchHelp({value:jQuery(this.getInputDomRef()).val()});e.preventDefault();e.stopImmediatePropagation();return;}if(this.oPopup&&this.oPopup.isOpen()){this._close();}else{this._open();var l=this._getListBox();l.scrollToIndex(l.getSelectedIndex());this._doSelect();}e.preventDefault();e.stopImmediatePropagation();};
sap.ui.commons.DropdownBox.prototype.onkeydown=function(e){if((jQuery.browser.msie&&(e.which==jQuery.sap.KeyCodes.DELETE||e.which==jQuery.sap.KeyCodes.BACKSPACE))||(jQuery.browser.webkit&&(e.which==jQuery.sap.KeyCodes.DELETE||e.which==jQuery.sap.KeyCodes.BACKSPACE))){this.onkeypress(e);}if(!jQuery.browser.msie||e.which!==jQuery.sap.KeyCodes.BACKSPACE){return;}this._iCursorPosBeforeBackspace=jQuery(this.getInputDomRef()).cursorPos();};
sap.ui.commons.DropdownBox.prototype.onpaste=function(e){if(this._oValueBeforePaste===null){this._oValueBeforePaste=jQuery(this.getInputDomRef()).val();}};
sap.ui.commons.DropdownBox.prototype.onkeyup=function(e){var k=e.which,o=jQuery.sap.KeyCodes;sap.ui.commons.TextField.prototype.onkeyup.apply(this,arguments);if(!(jQuery.browser.msie&&k===o.BACKSPACE)&&this._oValueBeforePaste===null||k===o.TAB){return;}if(!this.oPopup||!this.oPopup.isOpen()){this._open();}var r=jQuery(this.getInputDomRef()),v=false;if(k===o.BACKSPACE&&this._iCursorPosBeforeBackspace!==null){var c=r.cursorPos();if(this._iCursorPosBeforeBackspace!==c){c++;}this._iCursorPosBeforeBackspace=null;v=this._doTypeAhead(r.val().substr(0,c-1),"");}else if(!(v=this._doTypeAhead("",r.val()))){r.val(this._oValueBeforePaste);}if(v){this._getListBox().rerender();}this._oValueBeforePaste=null;};
sap.ui.commons.DropdownBox.prototype.onsaphome=function(e){if(!this.oPopup||!this.oPopup.isOpen()){this._updateSelection();e.preventDefault();}else{sap.ui.commons.ComboBox.prototype.onsaphome.apply(this,arguments);}};
sap.ui.commons.DropdownBox.prototype.onsapdelete=function(e){if(!this.oPopup||!this.oPopup.isOpen()){return;}var l=this._getListBox(),i=l.getSelectedItem(),m=i.getId().match(/\-h\-([0-4])/),a=l.getSelectedIndex();if(m&&m.length===2){this._oHistory.remove(i.getText());l.removeItem(a);var b=this._oHistory.get().length;if(b===0){l.removeItem(0);}l.rerender();var n=a+(this._searchHelpItem?2:0);if(n==b){n++;}l.setSelectedIndex(n);this.setValue(l.getSelectedItem().getText());}};
sap.ui.commons.DropdownBox.prototype.onkeypress=function(e){var k=e.which,i=e.keyCode,o=jQuery.sap.KeyCodes;if(sap.ui.commons.ComboBox._isHotKey(e)||i===o.HOME||i===o.F4&&e.which===0){return;}else if(i==o.ESCAPE){var v=this.getProperty("value");var a=this.getInputDomRef();if(a&&a.value!==v){jQuery(a).val(v);}return;}var n=String.fromCharCode(k),r=jQuery(this.getInputDomRef()),c=r.cursorPos(),s=r.val();if(!this.oPopup||!this.oPopup.isOpen()){this._open();}var b=false;if(k===o.BACKSPACE){b=this._doTypeAhead(s.substr(0,c-1),"");}else{b=this._doTypeAhead(s.substr(0,c),n);}if(b){this._getListBox().rerender();}e.preventDefault();};
sap.ui.commons.DropdownBox.prototype.onsapright=function(e){this._updateSelection(1);e.preventDefault();};
sap.ui.commons.DropdownBox.prototype.onsapleft=function(e){this._updateSelection(-1);e.preventDefault();};
sap.ui.commons.DropdownBox.prototype.onfocusin=function(e){var r=jQuery(this.getInputDomRef()),l=r.val().length;if(l>0){this._doSelect(0,l);}};
sap.ui.commons.DropdownBox.prototype.onselect=function(e){if(this._bIgnoreSelect){this._bIgnoreSelect=false;this.iOldTimestamp=e.originalEvent.timeStamp;return;}if(this.iOldTimestamp&&e.originalEvent.timeStamp-this.iOldTimestamp<50){return;}this.iOldTimestamp=undefined;var r=jQuery(this.getInputDomRef()),n=r.cursorPos(),v=r.val();if(v.length>0){this._doTypeAhead(v.substr(0,n),"");}e.preventDefault();};
sap.ui.commons.DropdownBox.prototype._doSelect=function(s,e){this._bIgnoreSelect=true;var d=this.getInputDomRef();if(d){var r=jQuery(d);r.selectText(s?s:0,e?e:r.val().length);}return this;};
sap.ui.commons.DropdownBox.prototype._updateSelection=function(m){var r=jQuery(this.getInputDomRef()),n=r.cursorPos()+(m||0),v=r.val();this._doTypeAhead(v.substr(0,n),"");this._getListBox().rerender();};
sap.ui.commons.DropdownBox.prototype._doTypeAhead=function(v,n,b){if(this.__doTypeAhead===true){return;}this.__doTypeAhead=true;var l=this._getListBox(),m=this.getMaxPopupItems(),a=this.__aItems||l.getItems(),c=a.length,h=a.length>this._iItemsForHistory,f=!b&&h,o=v+n,s=new RegExp("[.*+?|()\\[\\]{}\\\\]","g"),r=o.toLowerCase().replace(s,"\\$&"),d=RegExp("^"+r+".*$"),e=n&&n.length||0,$=jQuery(this.getInputDomRef());this.__aItems=a;var g,j=this._getFilteredItems(a,d),k=j.length>0;if(k){if(f){g=j;}else{g=a.slice(0);}var p=[];if(h){p=this._addHistoryItems(g,f&&d);l.setItems(g);c=g.length;}l.setVisibleItems(m<c?m:c);var q,t=p.length;if(!f&&t>0){p=this._getFilteredItems(p,d);q=p[0];}if(f){q=j[0];}else if(!q){if(j.length>0){q=j[0];}else{q=g[0];}}var u=this._searchHelpItem;if(u){l.insertItem(u[0],t++).insertItem(u[1],t);}var i=l.indexOfItem(q),w=q.getText();$.val(w);this._sTypedChars=o;this._doSelect(v.length+e,w.length);l.setSelectedIndex(i);l.scrollToIndex(i);this._iClosedUpDownIdx=i;}else{$=this.$();$.addClass("sapUiTfErr");jQuery.sap.delayedCall(300,$,"removeClass",["sapUiTfErr"]);l.setVisibleItems(m<c?m:c);}this.__doTypeAhead=false;return k;};
sap.ui.commons.DropdownBox.prototype._prepareOpen=function(l,p){this._oValueBeforeOpen=this.$().val();this._doTypeAhead("",jQuery(this.getInputDomRef()).val(),true);return this;};
sap.ui.commons.DropdownBox.prototype._cleanupClose=function(l){if(this.__aItems){l.setItems(this.__aItems);this.__aItems=undefined;}this._oValueBeforeOpen=null;return this;};
sap.ui.commons.DropdownBox.prototype._getFilteredItems=function(a,r){var t=a.slice(0),o;for(var i=t.length-1;i>=0;i--){o=t[i];if(!r.test(o.getText().toLowerCase())||!o.getEnabled()){t.splice(i,1);}}return t;};
sap.ui.commons.DropdownBox.prototype._addHistoryItems=function(a,r){var s=this.getId()+"-h-",o,h=this._oHistory.get(),l=h.length,n=[];for(var i=0,j=0;j<this.getMaxHistoryItems()&&i<l;i++){if(!r||r.test(h[i])){o=(o=sap.ui.getCore().byId(s+j))&&o.setText(h[i])||new sap.ui.core.ListItem(s+j,{text:h[i]});n.push(o);j++;}}if(n.length>0){var b=s+"separator",c=this._getSeparator(b);n.push(c);}a.unshift.apply(a,n);return n;};
sap.ui.commons.DropdownBox.prototype._getSeparator=function(s){if(!this.__oSeparator&&s){this.__oSeparator=sap.ui.getCore().byId(s)||new sap.ui.core.SeparatorItem(s);}return this.__oSeparator||null;};
sap.ui.commons.DropdownBox.prototype.fireChange=function(a){this.fireEvent("change",a);if(a.newValue){this._oHistory.add(a.newValue);}return this;};
sap.ui.commons.DropdownBox.prototype.setValue=function(v){v=(v===undefined||v===null||v==="")?"":v;var a=this.getItems(),t,b=false;for(var i=0,l=a.length;i<l&&!b;i++){t=a[i].getText();b=t===v;}if(b){sap.ui.commons.ComboBox.prototype.setValue.call(this,v);}else if(v===""&&a.length>0){sap.ui.commons.ComboBox.prototype.setValue.call(this,a[0].getText());}return this;};
sap.ui.commons.DropdownBox.prototype.applyFocusInfo=function(f){var i=jQuery(this.getInputDomRef());if(jQuery.sap.startsWithIgnoreCase(this.getValue(),f.sTypedChars)){i.val(f.sTypedChars);this.focus();this._doTypeAhead(f.sTypedChars,"");}else{f.sTypedChars="";this.focus();this._doSelect();}return this;};
sap.ui.commons.DropdownBox.prototype.getTooltip_AsString=function(){var t=sap.ui.commons.ComboBox.prototype.getTooltip_AsString.apply(this,arguments);if(!this._searchHelpItem){return t;}else{var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.commons");var s=r.getText("DDBX_SHI_ARIA");s=s==="DDBX_SHI_ARIA"?"Open search help via {0}":s;var a=this._searchHelpItem[0]&&this._searchHelpItem[0].getAdditionalText()||r.getText("DDBX_SHIF4");a=a==="DDBX_SHIF4"?"F4":a;s=s.replace("{0}",a);return(t?t+" - ":"")+s;}};
sap.ui.commons.DropdownBox.prototype._handleSelect=function(c){if(this._searchHelpItem&&c.getParameter("selectedItem")===this._searchHelpItem[0]){var e=jQuery.Event("sapshow");e.which=jQuery.sap.KeyCodes.F4;this.onsapshow(e);}else{var i=c.getParameter("selectedItem");if(!i){i=sap.ui.getCore().byId(c.getParameter("selectedId"));}if(i.getId().search(this.getId()+"-h-")!=-1){var l=this._getListBox(),a=l.getItems();var b=this._oHistory.get().length;for(var d=b;d<a.length;d++){if(a[d].getText()==i.getText()){c.mParameters.selectedIndex=d;if(!c.getParameter("selectedIndices")){c.mParameters.selectedIndices=new Array(1);c.mParameters.aSelectedIndices=new Array(1);}c.mParameters.selectedIndices[0]=d;c.mParameters.aSelectedIndices[0]=d;c.mParameters.selectedItem=a[d];break;}}}return sap.ui.commons.ComboBox.prototype._handleSelect.apply(this,arguments);}};
sap.ui.commons.DropdownBox.prototype.setSearchHelpEnabled=function(e,t,a,i){this.setProperty("searchHelpEnabled",e);if(t){this.setProperty("searchHelpText",t);}else{t=this.getSearchHelpText();}if(a){this.setProperty("searchHelpAdditionalText",a);}else{a=this.getSearchHelpAdditionalText();}if(i){this.setProperty("searchHelpIcon",i);}else{i=this.getSearchHelpIcon();}if(e){var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.commons");if(r){t=t||r.getText("DDBX_SHI");t=t==="DDBX_SHI"?"Search Help":t;a=a||r.getText("DDBX_SHIF4");a=a==="DDBX_SHIF4"?"F4":a;}i=i||sap.ui.resource("sap.ui.commons","img/dropdown/ico12_f4.gif");if(!this._searchHelpItem){this._searchHelpItem=[new sap.ui.core.ListItem(this.getId()+"_shi",{text:t,additionalText:a,enabled:true,icon:i}),new sap.ui.core.SeparatorItem()];}else{this._searchHelpItem[0].setText(t).setAdditionalText(a).setIcon(i);}}else{if(this._searchHelpItem){this._searchHelpItem[0].destroy();this._searchHelpItem[1].destroy();this._searchHelpItem=null;}}return this;};
sap.ui.commons.DropdownBox.prototype.setSearchHelpText=function(s){this.setProperty("searchHelpText",s);this.setSearchHelpEnabled(this.getSearchHelpEnabled(),s,this.getSearchHelpAdditionalText(),this.getSearchHelpIcon());return this;};
sap.ui.commons.DropdownBox.prototype.setSearchHelpAdditionalText=function(s){this.setProperty("searchHelpAdditionalText",s);this.setSearchHelpEnabled(this.getSearchHelpEnabled(),this.getSearchHelpText(),s,this.getSearchHelpIcon());return this;};
sap.ui.commons.DropdownBox.prototype.setSearchHelpIcon=function(s){this.setProperty("searchHelpIcon",s);this.setSearchHelpEnabled(this.getSearchHelpEnabled(),this.getSearchHelpText(),this.getSearchHelpAdditionalText(),s);return this;};
sap.ui.commons.DropdownBox.prototype.checkValueInItems=function(){var v=this.getValue();var a=this.getItems();if(a&&a.length>0){var b=false;for(var i=0,l=a.length;i<l&&!b;i++){b=a[i].getText()===v;}if(!b){v=a[0].getText();sap.ui.commons.ComboBox.prototype.setValue.call(this,v);}}else{v="";sap.ui.commons.ComboBox.prototype.setValue.call(this,v);}return v;};
sap.ui.commons.DropdownBox.prototype.setMaxHistoryItems=function(m){var o=this.getMaxHistoryItems();var s=this.getId()+"-h-";var a;this.setProperty('maxHistoryItems',m,true);if(m<o){var l=this._getListBox();for(var i=m;i<o;i++){a=sap.ui.getCore().byId(s+i);if(a){l.removeItem(a);a.destroy();}}if(m==0&&this.__oSeparator){l.removeItem(this.__oSeparator);}}};
sap.ui.commons.DropdownBox.prototype.clearHistory=function(){this._oHistory.clear();var s=this.getId()+"-h-";var l=this._getListBox();var o;for(var i=0;i<this.getMaxHistoryItems();i++){if(o=sap.ui.getCore().byId(s+i)){l.removeItem(o);o.destroy();}}if(this.__oSeparator){l.removeItem(this.__oSeparator);}};
