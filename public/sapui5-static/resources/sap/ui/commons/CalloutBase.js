/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.ui.commons.CalloutBase");jQuery.sap.require("sap.ui.commons.library");jQuery.sap.require("sap.ui.core.TooltipBase");sap.ui.core.TooltipBase.extend("sap.ui.commons.CalloutBase",{metadata:{publicMethods:["adjustPosition","close"],library:"sap.ui.commons",events:{"open":{},"close":{}}}});sap.ui.commons.CalloutBase.M_EVENTS={'open':'open','close':'close'};
sap.ui.commons.CalloutBase.prototype.init=function(){this.oPopup=new sap.ui.core.Popup();this.oPopup.setShadow(true);this.oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.commons");this.setMyPosition("begin bottom");this.setAtPosition("begin top");this.setOffset("0 -10");};
sap.ui.commons.CalloutBase.prototype.exit=function(){this.oPopup.close();this.oPopup.destroy();this.oPopup=null;this.oRb=null;};
sap.ui.commons.CalloutBase.prototype._getPopup=function(){return this.oPopup;};
sap.ui.commons.CalloutBase.prototype.isMouseOver=function(e){var d=this.getDomRef(),x=e.pageX,y=e.pageY,i=false;if(d){i=x>d.offsetLeft&&x<d.offsetLeft+d.offsetWidth&&y>d.offsetTop&&y<d.offsetTop+d.offsetHeight;}return i;};
sap.ui.commons.CalloutBase.prototype.adjustPosition=function(){if(!this.oPopup.isOpen()){return;}var p=this.oParent.getDomRef();this.oPopup.setPosition(this.getMyPosition(),this.getAtPosition(),p,this.getOffset(),this.getCollision());var o=jQuery(this.getDomRef());var a=jQuery(p);var b=o.offset().top>a.offset().top;var t=o.outerWidth()||0;var r=a.outerWidth()||0;var c=o.offset().left;var d=a.offset().left;var e=Math.abs(d-c)>Math.abs(d+r-c-t);if(sap.ui.getCore().getConfiguration().getRTL()){e=!e;}var f=jQuery.sap.byId(this.getId()+"-arrow");f.toggleClass("sapUiCltBaseArrT",b).toggleClass("sapUiCltBaseArrB",!b).toggleClass("sapUiCltBaseArrR",e);var l=f.offset().left;f.toggleClass("sapUiCltBaseArrN",l<d||l>d+r);};
sap.ui.commons.CalloutBase.prototype.focus=function(){if(this.oPopup.isOpen()){jQuery.sap.focus(jQuery.sap.byId(this.getId()+"-cont").firstFocusableDomRef());}};
sap.ui.commons.CalloutBase.prototype.openPopup=function(s){this.oParentControl=s;this.oParentFocusInfo=s.getFocusInfo();this.oPopup.attachEvent("opened",this.handleOpened,this);sap.ui.core.TooltipBase.prototype.openPopup.call(this,s);this.adjustPosition();this.fireOpen({parent:this._parentControl});};
sap.ui.commons.CalloutBase.prototype.close=function(){if(this.oPopup.isOpen()&&!this.sCloseNowTimeout){if(this.sOpenTimeout){jQuery.sap.clearDelayedCall(this.sOpenTimeout);this.sOpenTimeout=null;}this.closePopup();}};
sap.ui.commons.CalloutBase.prototype.closePopup=function(){jQuery("body").unbind("mouseover.callout");sap.ui.core.TooltipBase.prototype.closePopup.call(this);if(this.oParentControl&&this.bFocused){this.oParentControl.applyFocusInfo(this.oParentControl.getFocusInfo);this.bFocused=false;}this.fireClose({});};
sap.ui.commons.CalloutBase.prototype.onkeydown=function(e){var c=e.ctrlKey&&e.which==jQuery.sap.KeyCodes.I;var b=e.which==jQuery.sap.KeyCodes.ESCAPE;if(!c&&!b){return;}if(c){if(this.oPopup.isOpen()){jQuery.sap.log.debug("Callout: CtrlI. Me already opened");return;}this.bDoFocus=true;}sap.ui.core.TooltipBase.prototype.onkeydown.call(this,e);};
sap.ui.commons.CalloutBase.prototype.handleOpened=function(){this.oPopup.detachEvent("opened",this.handleOpened,this);if(this.bDoFocus){this.focus();this.bDoFocus=false;this.bFocused=true;var b=jQuery.proxy(function(e){if(!this.oPopup||!this.oPopup.isOpen()){jQuery("body").unbind("mouseover.callout");return;}var i=this.isMouseOver(e);if(!i&&!this.sCloseNowTimeout&&!this.sOpenTimeout){this.sCloseNowTimeout=jQuery.sap.delayedCall(400,this,"closePopup");}if(i&&this.sCloseNowTimeout){jQuery.sap.clearDelayedCall(this.sCloseNowTimeout);this.sCloseNowTimeout=null;}},this);jQuery("body").bind("mouseover.callout",b);}};
sap.ui.commons.CalloutBase.prototype.onfocusin=function(e){jQuery.sap.log.debug("Callout: onfocusin event");this.bFocused=true;var s=e.target;if(s.id===this.getId()+"-fhfe"){jQuery.sap.focus(jQuery.sap.byId(this.getId()+"-cont").lastFocusableDomRef());}else if(s.id===this.getId()+"-fhee"){jQuery.sap.focus(jQuery.sap.byId(this.getId()+"-cont").firstFocusableDomRef());}};
sap.ui.commons.CalloutBase.prototype.onfocusout=function(e){return;};
