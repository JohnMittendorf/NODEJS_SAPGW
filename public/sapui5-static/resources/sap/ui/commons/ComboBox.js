/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.ui.commons.ComboBox");jQuery.sap.require("sap.ui.commons.library");jQuery.sap.require("sap.ui.commons.TextField");sap.ui.commons.TextField.extend("sap.ui.commons.ComboBox",{metadata:{interfaces:["sap.ui.commons.ToolbarItem"],library:"sap.ui.commons",properties:{"maxPopupItems":{type:"int",group:"Behavior",defaultValue:10},"displaySecondaryValues":{type:"boolean",group:"Misc",defaultValue:false},"selectedKey":{type:"string",group:"Data",defaultValue:null},"selectedItemId":{type:"string",group:"Data",defaultValue:null}},defaultAggregation:"items",aggregations:{"items":{type:"sap.ui.core.ListItem",multiple:true,singularName:"item",bindable:"bindable"}},associations:{"listBox":{type:"sap.ui.commons.ListBox",multiple:false}}}});jQuery.sap.require("jquery.sap.strings");jQuery.sap.require("sap.ui.core.Popup");sap.ui.commons.ComboBox.getMetadata()._mHiddenAggregations={"myListBox":{multiple:false,type:"sap.ui.commons.ListBox"}};
sap.ui.commons.ComboBox.prototype.init=function(){this._iClosedUpDownIdx=-1;this._sCloseId=null;this.setAccessibleRole(sap.ui.core.AccessibleRole.Combobox);};
sap.ui.commons.ComboBox.prototype.exit=function(){if(this._oListBox){this._oListBoxDelegate&&this._oListBox.removeDelegate(this._oListBoxDelegate);if(this.getAggregation("myListBox")){this.destroyAggregation("myListBox",true);}else{this._oListBox.destroy();}this._oListBox=null;}};
;
sap.ui.commons.ComboBox.prototype.onclick=function(e){if(this.getEnabled&&this.getEnabled()&&this.getEditable()&&e.target===this.getF4ButtonDomRef()){if(this.oPopup&&this.oPopup.isOpen()){this._close();}else if(!this._F4ForClose){this._open();}this.focus();}this._F4ForClose=false;};
sap.ui.commons.ComboBox.prototype.onmousedown=function(e){if(e.target!==this.getF4ButtonDomRef()){return;}if(this.oPopup&&this.oPopup.isOpen()){this._F4ForClose=true;}else{this._F4ForOpen=true;}};
sap.ui.commons.ComboBox.prototype.onsapshow=function(e){if(this.oPopup&&this.oPopup.isOpen()){this._close();}else{this._open();}e.preventDefault();e.stopImmediatePropagation();};
sap.ui.commons.ComboBox.prototype.onsapnextmodifiers=function(e){if(e.keyCode==jQuery.sap.KeyCodes.ARROW_DOWN&&e.altKey){this.onsapshow(e);e.stopPropagation();}};
sap.ui.commons.ComboBox.prototype.onsaphide=function(e){this._close();e.stopPropagation();};
sap.ui.commons.ComboBox.prototype.onsapescape=function(e){this._close();sap.ui.commons.TextField.prototype.onsapescape.apply(this,arguments);};
sap.ui.commons.ComboBox.prototype.onsapenter=function(e){this._close();this._checkChange(e,true);};
sap.ui.commons.ComboBox.prototype.onsapfocusleave=function(e){this._resetCheck();var l=this._getListBox();if(e.relatedControlId&&jQuery.sap.containsOrEquals(l.getFocusDomRef(),sap.ui.getCore().byId(e.relatedControlId).getFocusDomRef())){this.focus();}else{this._checkChange(e,true);}};
sap.ui.commons.ComboBox.prototype._checkChange=function(e,b){this._resetCheck();if(!b){this._sCheckId=jQuery.sap.delayedCall(50,this,"_checkChange",[e,true]);return;}var o=this.getInputDomRef();if(!o){return;}var n=jQuery(o).val(),a=this.getValue();if(!this._F4ForOpen&&(this.getEditable()&&this.getEnabled()&&(a!=n))){this.setValue(n,true);var c=this.getItems(),d=null,t,k,s;for(var i=0,l=c.length;i<l;i++){t=c[i].getText();if(t===n){d=c[i];k=d.getKey();s=d.getId();break;}}this.setProperty("selectedKey",k,true);this.setProperty("selectedItemId",s,true);this.fireChange({newValue:n,selectedItem:d});}};
sap.ui.commons.ComboBox.prototype._resetCheck=function(){if(!this._sCheckId){return;}jQuery.sap.clearDelayedCall(this._sCheckId);this._sCheckId=null;};
sap.ui.commons.ComboBox.prototype.onkeypress=function(e){if(this._sTypeAhead){jQuery.sap.clearDelayedCall(this._sTypeAhead);}var k=jQuery.sap.KeyCodes;if(sap.ui.commons.ComboBox._isHotKey(e)||e.keyCode===k.F4&&e.which===0){return;}var i=e.which||e.keyCode;if(i!==k.DELETE&&i!==k.BACKSPACE&&i!==k.ESCAPE){this._sTypeAhead=jQuery.sap.delayedCall(200,this,"_doTypeAhead");}else{sap.ui.commons.TextField.prototype.onkeypress.apply(this,arguments);}};
sap.ui.commons.ComboBox.prototype.onsapup=function(e){if(!this.getEditable()){return;}var l=this._getListBox(),a=l.getItems(),d=this.getInputDomRef(),v=jQuery(d).val();var i=this._prepareUpDown(a,v);i=this._updateIdx(a,d,i-1,i);l.setSelectedIndex(i);l.scrollToIndex(i,true);e.preventDefault();e.stopPropagation();};
sap.ui.commons.ComboBox.prototype.onsapdown=function(e){if(!this.getEditable()){return;}var l=this._getListBox(),a=l.getItems(),d=this.getInputDomRef(),v=jQuery(d).val();var i=this._prepareUpDown(a,v);i=this._updateIdx(a,d,i+1,i);l.setSelectedIndex(i);l.scrollToIndex(i,true);e.preventDefault();e.stopPropagation();};
sap.ui.commons.ComboBox.prototype.onsaphome=function(e){if(!this.getEditable()||!this.oPopup||!this.oPopup.isOpen()){return;}var l=this._getListBox(),a=l.getItems(),d=this.getInputDomRef();var i=this._updateIdx(a,d,0);l.setSelectedIndex(i);l.scrollToIndex(0,true);e.preventDefault();};
sap.ui.commons.ComboBox.prototype.onsapend=function(e){if(!this.getEditable()||!this.oPopup||!this.oPopup.isOpen()){return;}var l=this._getListBox(),a=l.getItems(),d=this.getInputDomRef();var i=a.length-1;i=this._updateIdx(a,d,i);l.setSelectedIndex(i);l.scrollToIndex(i,true);e.preventDefault();};
sap.ui.commons.ComboBox.prototype._doTypeAhead=function(){this._sTypeAhead=null;var o=this._getListBox(),a=o.getItems(),b,t,r=jQuery(this.getInputDomRef()),v=r.val(),s=jQuery.sap.startsWithIgnoreCase;this._sTypedChars=v;var i=0;for(var l=a.length;i<l;i++){b=a[i];t=""+b.getText();if(s(t,v)&&b.getEnabled()){r.val(t);this._doSelect(v.length,t.length);o.setSelectedIndex(i);o.scrollToIndex(i,true);return;}}o.clearSelection();o.scrollToIndex(i,true);};
sap.ui.commons.ComboBox.prototype._prepareUpDown=function(a,v){var t;if(this._iClosedUpDownIdx>=0&&a[this._iClosedUpDownIdx]&&a[this._iClosedUpDownIdx].getText()!==v){this._iClosedUpDownIdx=-1;}if(this._iClosedUpDownIdx===-1){for(var i=0,l=a.length;i<l;i++){t=a[i].getText();if(t===v){this._iClosedUpDownIdx=i;break;}}}return this._iClosedUpDownIdx;};
sap.ui.commons.ComboBox.prototype._updateIdx=function(a,d,n,c){var l=a.length,f=n===0&&c===undefined,b=n===l-1&&c===undefined,e=c!==undefined&&c<n||f,i=(n<0?0:(n<l?n:l-1)),r=jQuery(d);var o,v=false;do{n=e?i++:i--;o=a[n];v=o&&o.getEnabled()&&!(o instanceof sap.ui.core.SeparatorItem)&&o.getId()!==this.getId()+"_shi";}while(!v&&i<l&&i>=0);if(v){var t=o.getText();r.val(t);this._doSelect();}else{n=c;}this._iClosedUpDownIdx=n;return n;};
sap.ui.commons.ComboBox.prototype._doSelect=function(s,e){var d=this.getInputDomRef();if(d){var r=jQuery(d);d.focus();r.selectText(s?s:0,e?e:r.val().length);}return this;};
sap.ui.commons.ComboBox.prototype.getFocusDomRef=function(){return this.getInputDomRef();};
sap.ui.commons.ComboBox.prototype.getInputDomRef=function(){return jQuery.sap.domById(this.getId()+"-input");};
sap.ui.commons.ComboBox.prototype.getF4ButtonDomRef=function(){return jQuery("#"+this.getId()+"-icon").get(0);};
sap.ui.commons.ComboBox.prototype._getPrivateListBox=function(){if(this._oListBox){return this._oListBox;}this._oListBox=new sap.ui.commons.ListBox(this.getId()+"-lb",{allowMultiSelect:false});this.setAggregation("myListBox",this._oListBox,true);return this._oListBox;};
sap.ui.commons.ComboBox.prototype._getListBox=function(u){var l=this.getListBox(),o;if(l){o=sap.ui.getCore().getControl(l);}else{o=this._getPrivateListBox();}if(u){o.setAllowMultiSelect(false);o.setDisplaySecondaryValues(this.getDisplaySecondaryValues());var d=this.getDomRef();if(d){o.setMinWidth(jQuery(d).rect().width+"px");}}return o;};
sap.ui.commons.ComboBox.prototype._open=function(d){if(d===undefined){d=-1;}if(!this.getEditable()){return;}if(!this.oPopup){this.oPopup=new sap.ui.core.Popup();}this._F4ForOpen=false;var l=this._getListBox(!this.oPopup.isOpen());var p=this.oPopup;this._prepareOpen(l);if(!this._oListBoxDelegate){this._oListBoxDelegate={oCombo:this,onclick:function(o){var i=jQuery(o.target).closest("li").attr("id");var o=new sap.ui.base.Event("_internalSelect",this.oCombo,{selectedId:i});this.oCombo._handleSelect(o);}};}l.addDelegate(this._oListBoxDelegate);p.setContent(l);p.setAutoClose(true);p.setAutoCloseAreas([this.getDomRef()]);p.setDurations(0,0);p.setInitialFocusId(this.getId()+'-input');var s=this._rerenderListBox(l);if(s){return;}p.attachOpened(this._handleOpened,this);var e=sap.ui.core.Popup.Dock;p.open(d,e.BeginTop,e.BeginBottom,this);jQuery(l.getFocusDomRef()).attr("tabIndex","-1");l.$().attr("tabIndex","-1");jQuery(this.getDomRef()).attr("aria-expanded",true);};
sap.ui.commons.ComboBox.prototype._rerenderListBox=function(l){sap.ui.getCore().applyChanges();return false;};
sap.ui.commons.ComboBox.prototype._prepareOpen=function(o){var r=jQuery(this.getInputDomRef()),v=r.val(),a=o.getItems(),t,s=jQuery.sap.startsWithIgnoreCase,b=false,e=v==="",c;var i=0;for(var l=a.length;i<l;i++){c=a[i];if(!c.getEnabled()){continue;}t=""+c.getText();if(e||s(t,v)){b=true;this._iClosedUpDownIdx=i;r.val(t);this._doSelect();break;}}if(!b){i=-1;}var d=o.getItems().length;var m=this.getMaxPopupItems();o.setVisibleItems(m<d?m:d);o.setSelectedIndex(i);};
sap.ui.commons.ComboBox.prototype._handleOpened=function(){this.oPopup.detachOpened(this._handleOpened,this);var l=this._getListBox();l.scrollToIndex(this._iClosedUpDownIdx,true);l.attachSelect(this._handleSelect,this);this.oPopup.attachClosed(this._handleClosed,this);};
sap.ui.commons.ComboBox.prototype._close=function(e){if(this.oPopup){this.oPopup.close(0);}};
sap.ui.commons.ComboBox.prototype._handleClosed=function(){this.oPopup.detachClosed(this._handleClosed,this);var l=this._getListBox();l.removeDelegate(this._oListBoxDelegate);l.detachSelect(this._handleSelect,this);jQuery(this.getDomRef()).attr("aria-expanded",false);if(this._cleanupClose){this._cleanupClose(l);}};
sap.ui.commons.ComboBox.prototype._handleSelect=function(c){this._resetCheck();var s=c.getParameter("selectedIndex"),i=c.getParameter("selectedId"),o=c.getParameter("selectedItem");if(!o&&i){o=sap.ui.getCore().byId(i);if(o.getParent()!==this._getListBox(false)){o=null;}s=jQuery.inArray(o,this._getListBox().getItems());}if(o&&o.getEnabled()){this._close();var t=o.getText();this._iClosedUpDownIdx=s;this.setValue(t,true);this.setProperty("selectedKey",o.getKey(),true);this.setProperty("selectedItemId",o.getId(),true);this._sTypedChars=t;this.fireChange({newValue:t,selectedItem:o});}this._doSelect();return o;};
sap.ui.commons.ComboBox.prototype.getItems=function(){return this._getListBox()?this._getListBox().getItems():[];};
sap.ui.commons.ComboBox.prototype.insertItem=function(i,a){this._getListBox().insertItem(i,a);return this;};
sap.ui.commons.ComboBox.prototype.addItem=function(i){this._getListBox().addItem(i);return this;};
sap.ui.commons.ComboBox.prototype.removeItem=function(e){return this._getListBox().removeItem(e);};
sap.ui.commons.ComboBox.prototype.removeAllItems=function(){return this._getListBox().removeAllItems();};
sap.ui.commons.ComboBox.prototype.indexOfItem=function(i){return this._getListBox().indexOfItem(i);};
sap.ui.commons.ComboBox.prototype.destroyItems=function(){this._getListBox().destroyItems();return this;};
sap.ui.commons.ComboBox.prototype.setListBox=function(l){if(this._oListBox){if(this.getAggregation("myListBox")){this.destroyAggregation("myListBox",true);}else{this._oListBox.destroy();}this._oListBox=null;}this.setAssociation("listBox",l);return this;};
sap.ui.commons.ComboBox.prototype.getFocusInfo=function(){return{id:this.getId(),sTypedChars:this._sTypedChars};};
sap.ui.commons.ComboBox.prototype.applyFocusInfo=function(f){jQuery(this.getInputDomRef()).val(f.sTypedChars);this._doTypeAhead();return this;};
sap.ui.commons.ComboBox.prototype.onAfterRendering=function(e){this._getListBox().$().appendTo(sap.ui.getCore().getStaticAreaRef());};
sap.ui.commons.ComboBox._isHotKey=function(e){if(e.altKey||e.ctrlKey||e.metaKey){return true;}var k=e.keyCode||e.which,a=jQuery.sap.KeyCodes;switch(k){case a.ENTER:case a.SHIFT:case a.TAB:case a.ALT:case a.CONTROL:case a.END:case a.HOME:case a.ARROW_LEFT:case a.ARROW_UP:case a.ARROW_RIGHT:case a.ARROW_DOWN:return true;case a.F1:case a.F2:case a.F3:case a.F4:case a.F5:case a.F6:case a.F7:case a.F8:case a.F9:case a.F10:case a.F11:case a.F12:return e.which===0;default:return false;}};
sap.ui.commons.ComboBox.prototype.setSelectedKey=function(s){if(this.getSelectedKey()==s){return this;}var a=this._getListBox().getItems();var n=true;var b;for(var i=0;i<a.length;i++){if(a[i].getKey()==s&&a[i].getEnabled()){var o=a[i];b=o.getId();var v=o.getText();this.setValue(v,true);this._sTypedChars=v;n=false;break;}}if(!n){this.setProperty("selectedKey",s,true);this.setProperty("selectedItemId",b,true);}return this;};
sap.ui.commons.ComboBox.prototype.setSelectedItemId=function(s){if(this.getSelectedItemId()==s){return this;}var a=this._getListBox().getItems();var n=true;var k;for(var i=0;i<a.length;i++){if(a[i].getId()==s&&a[i].getEnabled()){var o=a[i];k=o.getKey();var v=o.getText();this.setValue(v,true);this._sTypedChars=v;n=false;break;}}if(!n){this.setProperty("selectedItemId",s,true);this.setProperty("selectedKey",k,true);}return this;};
sap.ui.commons.ComboBox.prototype.setValue=function(v,n){if(!n){var a=this._getListBox().getItems();var k;var s;for(var i=0;i<a.length;i++){if(a[i].getText()==v&&a[i].getEnabled()){var o=a[i];s=o.getId();k=o.getKey();break;}}this.setProperty("selectedKey",k,true);this.setProperty("selectedItemId",s,true);}sap.ui.commons.TextField.prototype.setValue.apply(this,[v]);this._sTypedChars=this.getValue();return this;};
sap.ui.commons.ComboBox.prototype.invalidate=function(o){if(!o||o!=this._getListBox()){sap.ui.core.Control.prototype.invalidate.apply(this,arguments);}else{if(this.getUIArea()){this.getUIArea().addInvalidatedControl(o);}}};
sap.ui.commons.ComboBox.prototype.clone=function(i){var c=sap.ui.core.Element.prototype.clone.apply(this,arguments),l=this.getAggregation("myListBox"),o;if(l){o=l.clone(i);c.setAggregation("myListBox",o,true);c._oListBox=o;}return c;};
