/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.ui.commons.RoadMap");jQuery.sap.require("sap.ui.commons.library");jQuery.sap.require("sap.ui.core.Control");sap.ui.core.Control.extend("sap.ui.commons.RoadMap",{metadata:{library:"sap.ui.commons",properties:{"numberOfVisibleSteps":{type:"int",group:"Misc",defaultValue:null},"firstVisibleStep":{type:"string",group:"Misc",defaultValue:null},"selectedStep":{type:"string",group:"Misc",defaultValue:null},"width":{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:'100%'},"visible":{type:"boolean",group:"Misc",defaultValue:true}},defaultAggregation:"steps",aggregations:{"steps":{type:"sap.ui.commons.RoadMapStep",multiple:true,singularName:"step"}},events:{"stepSelected":{},"stepExpanded":{}}}});sap.ui.commons.RoadMap.M_EVENTS={'stepSelected':'stepSelected','stepExpanded':'stepExpanded'};(function(){sap.ui.commons.RoadMap.prototype.init=function(){this.iStepWidth=-1;this.sCurrentFocusedStepRefId=null;};sap.ui.commons.RoadMap.prototype.exit=function(){if(this.sResizeListenerId){sap.ui.core.ResizeHandler.deregister(this.sResizeListenerId);this.sResizeListenerId=null;}};sap.ui.commons.RoadMap.prototype.setNumberOfVisibleSteps=function(n){var i=this.getDomRef()?true:false;this.setProperty("numberOfVisibleSteps",n,i);if(i){sap.ui.commons.RoadMapRenderer.updateScrollArea(this,true);}return this;};sap.ui.commons.RoadMap.prototype.setFirstVisibleStep=function(a){var i=this.getDomRef()?true:false;if(i){if(a){var o=sap.ui.getCore().byId(a);if(o&&o.getParent()&&(o.getParent()===this||o.getParent().getParent()===this)&&o.getVisible()){this.setProperty("firstVisibleStep",a,true);sap.ui.commons.RoadMapRenderer.updateScrollArea(this);}}else{this.setProperty("firstVisibleStep","",true);sap.ui.commons.RoadMapRenderer.updateScrollArea(this);}}else{this.setProperty("firstVisibleStep",a);}return this;};sap.ui.commons.RoadMap.prototype.setWidth=function(w){var i=this.getDomRef()?true:false;this.setProperty("width",w,i);if(i){sap.ui.commons.RoadMapRenderer.setRoadMapWidth(this,w);sap.ui.commons.RoadMapRenderer.updateScrollArea(this,true);}return this;};sap.ui.commons.RoadMap.prototype.setSelectedStep=function(a){var i=this.getDomRef()?true:false;if(i){if(a){var o=sap.ui.getCore().byId(a);if(o&&o.getParent()&&(o.getParent()===this||o.getParent().getParent()===this)&&o.getEnabled()&&o.getVisible()){sap.ui.commons.RoadMapRenderer.selectStepWithId(this,a);this.setProperty("selectedStep",a,true);}}else{sap.ui.commons.RoadMapRenderer.selectStepWithId(this,"");this.setProperty("selectedStep","",true);}}else{this.setProperty("selectedStep",a);}return this;};sap.ui.commons.RoadMap.prototype.onThemeChanged=function(e){this.iStepWidth=-1;this.invalidate();this.rerender();};sap.ui.commons.RoadMap.prototype.doBeforeRendering=function(){var b=false;var a=false;var c=this.getSteps();for(var i=0;i<c.length;i++){var o=c[i];if(o.getSubSteps().length==0||!o.getEnabled()){o.setProperty("expanded",false,true);}if(!o.getEnabled()&&!o.getVisible()&&this.getSelectedStep()==o.getId()){this.setProperty("selectedStep","",true);}else if(o.getEnabled()&&o.getVisible()&&this.getSelectedStep()==o.getId()){b=true;}if(o.getVisible()&&this.getFirstVisibleStep()==o.getId()){a=true;}var d=o.getSubSteps();for(var j=0;j<d.length;j++){var e=d[j];e.setProperty("expanded",false,true);if(!e.getEnabled()&&!e.getVisible()&&this.getSelectedStep()==e.getId()){this.setProperty("selectedStep","",true);}else if(e.getEnabled()&&e.getVisible()&&this.getSelectedStep()==e.getId()){b=true;}if(e.getVisible()&&this.getFirstVisibleStep()==e.getId()){a=true;}}}if(!b){this.setProperty("selectedStep","",true);}if(!a){this.setProperty("firstVisibleStep","",true);}if(this.sResizeListenerId){sap.ui.core.ResizeHandler.deregister(this.sResizeListenerId);this.sResizeListenerId=null;}};sap.ui.commons.RoadMap.prototype.onAfterRendering=function(){var a=this.getSteps();if(this.iStepWidth==-1&&a.length>0){var b=jQuery.sap.byId(a[0].getId());this.iStepWidth=b.outerWidth();}for(var i=0;i<a.length;i++){var o=a[i];sap.ui.commons.RoadMapRenderer.addEllipses(o);var c=o.getSubSteps();for(var j=0;j<c.length;j++){sap.ui.commons.RoadMapRenderer.addEllipses(c[j]);}}sap.ui.commons.RoadMapRenderer.updateScrollArea(this);this.sResizeListenerId=sap.ui.core.ResizeHandler.register(this.getDomRef(),jQuery.proxy(this.onresize,this));};sap.ui.commons.RoadMap.prototype.onresize=function(e){var d=function(){if(this.getDomRef()){sap.ui.commons.RoadMapRenderer.updateScrollArea(this,true);r(this,"prev");this.sResizeInProgress=null;}};if(jQuery.browser.mozilla){d.apply(this,[]);}else{if(!this.sResizeInProgress){this.sResizeInProgress=jQuery.sap.delayedCall(300,this,d);}}};sap.ui.commons.RoadMap.prototype.onclick=function(e){h(this,e);};sap.ui.commons.RoadMap.prototype.onsapselect=function(e){h(this,e);};sap.ui.commons.RoadMap.prototype.onfocusin=function(e){var t=jQuery(e.target);var j=t.attr("id");if(j&&jQuery.sap.endsWith(j,"-box")){this.sCurrentFocusedStepRefId=j.substring(0,j.length-4);}else if(j&&(jQuery.sap.endsWith(j,"-Start")||jQuery.sap.endsWith(j,"-End"))){}else{this.sCurrentFocusedStepRefId=sap.ui.commons.RoadMapRenderer.getFirstVisibleRef(this).attr("id");r(this);}jQuery.sap.byId(this.getId()).attr("tabindex","-1");};sap.ui.commons.RoadMap.prototype.onfocusout=function(e){jQuery.sap.byId(this.getId()).attr("tabindex","0");};sap.ui.commons.RoadMap.prototype.onsapprevious=function(e){f(e,this,"prev");};sap.ui.commons.RoadMap.prototype.onsapnext=function(e){f(e,this,"next");};sap.ui.commons.RoadMap.prototype.onsaphome=function(e){f(e,this,"first");};sap.ui.commons.RoadMap.prototype.onsapend=function(e){f(e,this,"last");};var h=function(t,e){e.stopPropagation();e.preventDefault();var j=jQuery(e.target);var a=j.attr("id");if(!a){return;}var i=a.lastIndexOf("-expandend");if(i!=-1){var o=sap.ui.getCore().byId(a.substring(0,i));if(o&&t.indexOfStep(o)>=0){o.handleSelect(e,true);return;}}if(a==t.getId()+"-Start"){if(j.hasClass("sapUiRoadMapStartScroll")){s(t,"prev",true);}else{r(t);}}else if(a==t.getId()+"-End"){if(j.hasClass("sapUiRoadMapEndScroll")){s(t,"next",true);}else{r(t);}}};var s=function(t,d,u){sap.ui.commons.RoadMapRenderer.scrollToNextStep(t,d,function(a){var i=a.lastIndexOf("-expandend");if(i!=-1){a=a.substring(0,i);}t.setProperty("firstVisibleStep",a,true);if(u){r(t,d);}});};var f=function(e,t,d){if(e){e.stopPropagation();e.preventDefault();}if(!t.sCurrentFocusedStepRefId){return;}var a=d+"All";var i=false;if(d=="first"){a="prevAll";i=true;}else if(d=="last"){a="nextAll";i=true;}var c=jQuery.sap.byId(t.sCurrentFocusedStepRefId);var j=c[a](":visible");var b=jQuery(j.get(i?j.length-1:0)).attr("id");if(b){if(!sap.ui.commons.RoadMapRenderer.isVisibleRef(t,b)){s(t,d);}jQuery.sap.byId(b+"-box").get(0).focus();}};var r=function(t,d){if(!t.sCurrentFocusedStepRefId){return;}if(d&&!sap.ui.commons.RoadMapRenderer.isVisibleRef(t,t.sCurrentFocusedStepRefId)){f(null,t,d);}else{jQuery.sap.byId(t.sCurrentFocusedStepRefId+"-box").get(0).focus();}};}());
