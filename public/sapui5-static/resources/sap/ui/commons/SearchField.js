/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.ui.commons.SearchField");jQuery.sap.require("sap.ui.commons.library");jQuery.sap.require("sap.ui.core.Control");sap.ui.core.Control.extend("sap.ui.commons.SearchField",{metadata:{publicMethods:["clearHistory","suggest"],library:"sap.ui.commons",properties:{"enableListSuggest":{type:"boolean",group:"Behavior",defaultValue:true},"showListExpander":{type:"boolean",group:"Behavior",defaultValue:true},"enableClear":{type:"boolean",group:"Behavior",defaultValue:false},"showExternalButton":{type:"boolean",group:"Behavior",defaultValue:false},"value":{type:"string",group:"Data",defaultValue:''},"enabled":{type:"boolean",group:"Behavior",defaultValue:true},"editable":{type:"boolean",group:"Behavior",defaultValue:true},"visible":{type:"boolean",group:"Behavior",defaultValue:true},"width":{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},"maxLength":{type:"int",group:"Behavior",defaultValue:0},"textAlign":{type:"sap.ui.core.TextAlign",group:"Appearance",defaultValue:sap.ui.core.TextAlign.Begin},"visibleItemCount":{type:"int",group:"Behavior",defaultValue:20},"startSuggestion":{type:"int",group:"Behavior",defaultValue:3},"maxSuggestionItems":{type:"int",group:"Behavior",defaultValue:10},"maxHistoryItems":{type:"int",group:"Behavior",defaultValue:5}},aggregations:{"searchProvider":{type:"sap.ui.commons.SearchProvider",multiple:false}},events:{"search":{},"suggest":{}}}});sap.ui.commons.SearchField.M_EVENTS={'search':'search','suggest':'suggest'};jQuery.sap.require("sap.ui.commons.ComboBox");jQuery.sap.require("sap.ui.commons.TextField");jQuery.sap.require("sap.ui.commons.ListBox");jQuery.sap.require("sap.ui.core.History");(function(){var _=20;sap.ui.commons.SearchField.prototype.init=function(){c(this,this.getEnableListSuggest());this._oHistory=new sap.ui.core.History(this.getId());};sap.ui.commons.SearchField.prototype.exit=function(){this._ctrl.destroy();this._lb.destroy();if(this._btn){this._btn.destroy();}this._ctrl=null;this._lb=null;this._btn=null;this._oHistory=null;};sap.ui.commons.SearchField.prototype.onThemeChanged=function(e){this.invalidate();};sap.ui.commons.SearchField.prototype.onAfterRendering=function(){if(this.getShowExternalButton()){var i=jQuery.sap.byId(this._btn.getId()).outerWidth(true);jQuery.sap.byId(this._ctrl.getId()).css(sap.ui.getCore().getConfiguration().getRTL()?"left":"right",i+"px");}};sap.ui.commons.SearchField.prototype.getFocusDomRef=function(){return this._ctrl.getFocusDomRef();};sap.ui.commons.SearchField.prototype.fireSearch=function(m){var v=jQuery(this._ctrl.getInputDomRef()).val();if(!v||!this.getEditable()||!this.getEnabled()){return this;}if(!m){m={};}this.setValue(v);if(!m.noFocus){v=this.getValue();this.focus();this._oHistory.add(v);this.fireEvent("search",{query:v});}return this;};sap.ui.commons.SearchField.prototype.clearHistory=function(){this._oHistory.clear();};sap.ui.commons.SearchField.prototype.suggest=function(s,e){if(!this.getEnableListSuggest()||!s||!e){return;}this._ctrl.updateSuggestions(s,e);};sap.ui.commons.SearchField.prototype.setEnableListSuggest=function(e){if((this.getEnableListSuggest()&&e)||(!this.getEnableListSuggest()&&!e)){return;}c(this,e);this.setProperty("enableListSuggest",e);return this;};sap.ui.commons.SearchField.prototype.getValue=function(){return b(this,"Value");};sap.ui.commons.SearchField.prototype.setValue=function(v){return a(this,"Value",v,!!this.getDomRef());};sap.ui.commons.SearchField.prototype.getEnabled=function(){return b(this,"Enabled");};sap.ui.commons.SearchField.prototype.setEnabled=function(e){if(this._btn){this._btn.setEnabled(e&&this.getEditable());}return a(this,"Enabled",e);};sap.ui.commons.SearchField.prototype.getEditable=function(){return b(this,"Editable");};sap.ui.commons.SearchField.prototype.setEditable=function(e){if(this._btn){this._btn.setEnabled(e&&this.getEnabled());}return a(this,"Editable",e);};sap.ui.commons.SearchField.prototype.getMaxLength=function(){return b(this,"MaxLength");};sap.ui.commons.SearchField.prototype.setMaxLength=function(m){return a(this,"MaxLength",m);};sap.ui.commons.SearchField.prototype.getTextAlign=function(){return b(this,"TextAlign");};sap.ui.commons.SearchField.prototype.setTextAlign=function(t){return a(this,"TextAlign",t);};sap.ui.commons.SearchField.prototype.getTooltip=function(){return b(this,"Tooltip");};sap.ui.commons.SearchField.prototype.setTooltip=function(t){return a(this,"Tooltip",t);};sap.ui.commons.SearchField.prototype.getVisibleItemCount=function(){return b(this,"MaxPopupItems");};sap.ui.commons.SearchField.prototype.setVisibleItemCount=function(v){return a(this,"MaxPopupItems",v);};sap.ui.commons.SearchField.prototype.setShowExternalButton=function(s){if(!this._btn){jQuery.sap.require("sap.ui.commons.Button");var t=this;this._btn=new sap.ui.commons.Button(this.getId()+"-btn",{text:g("SEARCHFIELD_BUTTONTEXT"),enabled:this.getEditable()&&this.getEnabled(),press:function(){t.fireSearch();}});this._btn.setParent(this);}this.setProperty("showExternalButton",s);return this;};var a=function(t,m,v,s){t._ctrl["set"+m](v);if(!s){t.invalidate();}return t;};var b=function(t,s){return t._ctrl["get"+s]();};var c=function(t,e){if(!t._lb){t._lb=new sap.ui.commons.ListBox(t.getId()+"-lb");}var o=t._ctrl;var n=null;if(e){n=new sap.ui.commons.SearchField.CB(t.getId()+"-cb",{listBox:t._lb,maxPopupItems:_});}else{n=new sap.ui.commons.SearchField.TF(t.getId()+"-tf");}n.setParent(t);if(o){n.setValue(o.getValue());n.setEnabled(o.getEnabled());n.setEditable(o.getEditable());n.setMaxLength(o.getMaxLength());n.setTextAlign(o.getTextAlign());n.setTooltip(o.getTooltip());n.setMaxPopupItems(o.getMaxPopupItems());o.destroy();}t._ctrl=n;};var g=function(k,e){var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.commons");if(r){return r.getText(k,e);}return k;};jQuery.sap.require("sap.ui.core.Renderer");var d=function(r,o){r.write("<div");r.writeAttributeEscaped('id',o.getId()+'-searchico');r.writeAttribute('unselectable','on');if(sap.ui.getCore().getConfiguration().getAccessibility()){r.writeAttribute("role","presentation");}r.addClass("sapUiSearchFieldIco");r.writeClasses();r.write(">X</div>");};sap.ui.commons.SearchField.TF=function(i,s){sap.ui.commons.TextField.apply(this,arguments);};sap.ui.commons.SearchField.TF.prototype=jQuery.sap.newObject(sap.ui.commons.TextField.prototype);sap.ui.core.Element.defineClass("sap.ui.commons.SearchField.TF",{baseType:"sap.ui.commons.TextField",library:"sap.ui.commons"});sap.ui.commons.SearchField.TF.prototype.getInputDomRef=function(){return jQuery.sap.domById(this.getId()+"-input");};sap.ui.commons.SearchField.TF.prototype.getFocusDomRef=sap.ui.commons.SearchField.TF.prototype.getInputDomRef;sap.ui.commons.SearchField.TF.prototype.onkeypress=function(e){};sap.ui.commons.SearchField.TF.prototype.onkeyup=function(e){sap.ui.commons.SearchField.CB.prototype.onkeyup.apply(this,arguments);};sap.ui.commons.SearchField.TF.prototype._triggerSuggest=function(s){this._sSuggest=null;if((s&&s.length>=this.getParent().getStartSuggestion())||(!s&&this.getParent().getStartSuggestion()==0)){this.getParent().fireSuggest({value:s});}};sap.ui.commons.SearchField.TF.prototype._checkChange=function(e,f){this.getParent().fireSearch({noFocus:f});};sap.ui.commons.SearchField.TF.prototype.onfocusout=function(e){if(this.getEditable()&&this.getEnabled()&&this.getRenderer().onblur){this.getRenderer().onblur(this);}this._checkChange(e,true);};sap.ui.commons.SearchField.TF.prototype.onclick=function(e){if(e.target===jQuery.sap.domById(this.getId()+"-searchico")){if(this.getEditable()&&this.getEnabled()){this.focus();}if(!this.getParent().getEnableClear()){this._checkChange(e);}else{this.setValue("");this._triggerValueHelp=true;this.onkeyup();}}};sap.ui.commons.SearchField.TF.prototype.getMaxPopupItems=function(){return this._iVisibleItemCount?this._iVisibleItemCount:_;};sap.ui.commons.SearchField.TF.prototype.setMaxPopupItems=function(m){this._iVisibleItemCount=m;};jQuery.sap.require("sap.ui.commons.TextFieldRenderer");sap.ui.commons.SearchField.TFRenderer=sap.ui.core.Renderer.extend(sap.ui.commons.TextFieldRenderer);sap.ui.commons.SearchField.TFRenderer.renderOuterContent=d;sap.ui.commons.SearchField.TFRenderer.renderOuterAttributes=function(r,o){r.addClass("sapUiSearchFieldTf");};sap.ui.commons.SearchField.CB=function(i,s){sap.ui.commons.ComboBox.apply(this,arguments);this._mSuggestions={};this._aSuggestValues=[];};sap.ui.commons.SearchField.CB.prototype=jQuery.sap.newObject(sap.ui.commons.ComboBox.prototype);sap.ui.core.Element.defineClass("sap.ui.commons.SearchField.CB",{baseType:"sap.ui.commons.ComboBox",library:"sap.ui.commons"});sap.ui.commons.SearchField.CB.prototype.updateSuggestions=function(s,e){this._mSuggestions[s]=e;if(this.getInputDomRef()&&jQuery(this.getInputDomRef()).val()===s&&this._hasSuggestValue(s)){this._doUpdateList(s);this._aSuggestValues=[s];}};sap.ui.commons.SearchField.CB.prototype._getListBox=function(){return this.getParent()._lb;};sap.ui.commons.SearchField.CB.prototype._hasSuggestValue=function(s){return this._aSuggestValues.length>0&&s==this._aSuggestValues[this._aSuggestValues.length-1];};sap.ui.commons.SearchField.CB.prototype._doUpdateList=function(s,e){if((!this.oPopup||!this.oPopup.isOpen())&&!e){this._open();}else{this._updateList(s);}if(!this._lastKeyIsDel){this._doTypeAhead();}};sap.ui.commons.SearchField.CB.prototype.onclick=function(e){sap.ui.commons.ComboBox.prototype.onclick.apply(this,arguments);if(e.target===jQuery.sap.domById(this.getId()+"-searchico")){if(!this.getParent().getEnableClear()){this.getParent().fireSearch();}else{this.setValue("");this._triggerValueHelp=true;this.onkeyup(null,true);this._aSuggestValues=[];}if(this.getEditable()&&this.getEnabled()){this.focus();}}else if(jQuery.sap.containsOrEquals(jQuery.sap.domById(this.getId()+"-providerico"),e.target)){if(this.getEditable()&&this.getEnabled()){this.focus();}}};sap.ui.commons.SearchField.CB.prototype.onkeypress=function(e){};sap.ui.commons.SearchField.CB.prototype.onkeyup=function(e,s){if(e){var k=jQuery.sap.KeyCodes;if(sap.ui.commons.ComboBox._isHotKey(e)||e.keyCode===k.F4&&e.which===0){return;}var i=e.which||e.keyCode;if(i!==k.ESCAPE){this._triggerValueHelp=true;this._lastKeyIsDel=i==k.DELETE||i==k.BACKSPACE;}}if(this._triggerValueHelp){this._triggerValueHelp=false;if(this._sSuggest){jQuery.sap.clearDelayedCall(this._sSuggest);this._sSuggest=null;}var f=jQuery(this.getInputDomRef()).val();if((f&&f.length>=this.getParent().getStartSuggestion())||(!f&&this.getParent().getStartSuggestion()==0)){this._sSuggest=jQuery.sap.delayedCall(200,this,"_triggerSuggest",[f]);}else if(this._doUpdateList){this._doUpdateList(f,s);}}};sap.ui.commons.SearchField.CB.prototype._triggerSuggest=function(s){this._sSuggest=null;if(!this._mSuggestions[s]){this._aSuggestValues.push(s);var o=this.getParent().getSearchProvider();if(o){o._doSuggest(this.getParent(),s);}else{this.getParent().fireSuggest({value:s});}}else{this._doUpdateList(s);}};sap.ui.commons.SearchField.CB.prototype._updateList=function(s){var e=false;var l=this._getListBox();l.destroyAggregation("items",true);var f=function(l,v,n,o){v=v?v:[];var p=Math.min(v.length,n);if(o&&p>0){l.addItem(new sap.ui.core.SeparatorItem());}for(var i=0;i<p;i++){l.addItem(new sap.ui.core.ListItem({text:v[i]}));}return p;};var h=f(l,this.getParent()._oHistory.get(s),this.getParent().getMaxHistoryItems(),false);var j=f(l,s&&s.length>=this.getParent().getStartSuggestion()?this._mSuggestions[s]:[],this.getParent().getMaxSuggestionItems(),h>0);if(h==0&&j==0){l.addItem(new sap.ui.core.ListItem({text:g("SEARCHFIELD_NO_ITEMS"),enabled:false}));e=true;}var k=l.getItems().length;var m=this.getMaxPopupItems();l.setVisibleItems(m<k?m:k);l.setSelectedIndex(-1);l.setMinWidth(jQuery(this.getDomRef()).rect().width+"px");l.rerender();return e;};sap.ui.commons.SearchField.CB.prototype._prepareOpen=function(){};sap.ui.commons.SearchField.CB.prototype._open=function(){sap.ui.commons.ComboBox.prototype._open.apply(this,[0]);};sap.ui.commons.SearchField.CB.prototype._rerenderListBox=function(){return this._updateList(this._aSuggestValues.length>0?this._aSuggestValues[this._aSuggestValues.length-1]:null);};sap.ui.commons.SearchField.CB.prototype._checkChange=function(e,i,f){this.getParent().fireSearch({noFocus:f});};sap.ui.commons.SearchField.CB.prototype.onsapfocusleave=function(e){if(e.relatedControlId===this._getListBox().getId()){this.focus();return;}this._checkChange(e,true,true);};sap.ui.commons.SearchField.CB.prototype.onfocusout=function(e){if(this.getEditable()&&this.getEnabled()&&this.getRenderer().onblur){this.getRenderer().onblur(this);}this._checkChange(e,true,true);};sap.ui.commons.SearchField.CB.prototype.onsapshow=function(e){if(this.getParent().getShowListExpander()){sap.ui.commons.ComboBox.prototype.onsapshow.apply(this,arguments);}else{e.preventDefault();e.stopImmediatePropagation();}};sap.ui.commons.SearchField.CB.prototype._handleSelect=function(o){var i=sap.ui.commons.ComboBox.prototype._handleSelect.apply(this,arguments);if(i&&i.getEnabled()){this.getParent().fireSearch();}};jQuery.sap.require("sap.ui.commons.ComboBoxRenderer");sap.ui.commons.SearchField.CBRenderer=sap.ui.core.Renderer.extend(sap.ui.commons.ComboBoxRenderer);sap.ui.commons.SearchField.CBRenderer.renderOuterContent=function(r,o){if(o.getParent().getShowListExpander()){sap.ui.commons.ComboBoxRenderer.renderOuterContent.apply(this,arguments);}d.apply(this,arguments);if(o.getParent().getSearchProvider()&&o.getParent().getSearchProvider().getIcon()){r.write("<div");r.writeAttributeEscaped('id',o.getId()+'-providerico');r.writeAttribute('unselectable','on');if(sap.ui.getCore().getConfiguration().getAccessibility()){r.writeAttribute("role","presentation");}r.addClass("sapUiSearchFieldProvIco");r.writeClasses();r.write("><img src=\""+o.getParent().getSearchProvider().getIcon()+"\"></img></div>");}};sap.ui.commons.SearchField.CBRenderer.renderOuterAttributes=function(r,o){sap.ui.commons.ComboBoxRenderer.renderOuterAttributes.apply(this,arguments);r.addClass("sapUiSearchFieldCb");if(o.getParent().getSearchProvider()&&o.getParent().getSearchProvider().getIcon()){r.addClass("sapUiSearchFieldCbProv");}};}());
