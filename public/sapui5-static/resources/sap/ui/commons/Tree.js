/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.ui.commons.Tree");jQuery.sap.require("sap.ui.commons.library");jQuery.sap.require("sap.ui.core.Control");sap.ui.core.Control.extend("sap.ui.commons.Tree",{metadata:{publicMethods:["expandAll","collapseAll"],library:"sap.ui.commons",properties:{"title":{type:"string",group:"Misc",defaultValue:null},"width":{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:'auto'},"height":{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:'auto'},"showHeader":{type:"boolean",group:"Misc",defaultValue:true},"showHeaderIcons":{type:"boolean",group:"Misc",defaultValue:true},"showHorizontalScrollbar":{type:"boolean",group:"Misc",defaultValue:false},"minWidth":{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:null}},defaultAggregation:"nodes",aggregations:{"nodes":{type:"sap.ui.commons.TreeNode",multiple:true,singularName:"node"}},events:{"select":{allowPreventDefault:true}}}});sap.ui.commons.Tree.M_EVENTS={'select':'select'};sap.ui.commons.Tree.prototype.resizeListenerId;
sap.ui.commons.Tree.prototype.init=function(){this.bAllCollapsed=false;this.allowTextSelection(false);this.oSelectedNode=null;this.oSelectedContext=null;var i=jQuery.sap.getModulePath("sap.ui.commons",'/')+"themes/"+sap.ui.getCore().getConfiguration().getTheme();if(!sap.ui.getCore().getConfiguration().getRTL()){i+="/img/tree/";}else{i+="/img-RTL/tree/";}var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.commons");this.oCollapseAllButton=new sap.ui.commons.Button(this.getId()+"-CollapseAll",{icon:i+"CollapseAll.png",tooltip:r.getText("TREE_COLLAPSE_ALL"),lite:true});this.oExpandAllButton=new sap.ui.commons.Button(this.getId()+"-ExpandAll",{icon:i+"ExpandAll.png",tooltip:r.getText("TREE_EXPAND_ALL"),lite:true});this.oCollapseAllButton.attachPress(this.onCollapseAll,this);this.oExpandAllButton.attachPress(this.onExpandAll,this);this.oCollapseAllButton.addStyleClass("sapUiTreeCol");this.oExpandAllButton.addStyleClass("sapUiTreeExp");};
sap.ui.commons.Tree.prototype.exit=function(){if(this.oCollapseAllButton){this.oCollapseAllButton.destroy();this.oCollapseAllButton=null;}if(this.oExpandAllButton){this.oExpandAllButton.destroy();this.oExpandAllButton=null;}};
sap.ui.commons.Tree.prototype.onExpandAll=function(){this.expandAll();};
sap.ui.commons.Tree.prototype.onCollapseAll=function(){this.collapseAll();};
sap.ui.commons.Tree.prototype.expandAll=function(){var n=this.getNodes();for(var i=0;i<n.length;i++){n[i].expand(true);}};
sap.ui.commons.Tree.prototype.collapseAll=function(){var n=this.getNodes();for(var i=0;i<n.length;i++){n[i].collapse(true);}};
sap.ui.commons.Tree.prototype.onsapdown=function(e){this.moveFocus(false);e.preventDefault();};
sap.ui.commons.Tree.prototype.onsapup=function(e){this.moveFocus(true);e.preventDefault();};
sap.ui.commons.Tree.prototype.onsapleft=function(e){this.moveFocus(true);e.preventDefault();};
sap.ui.commons.Tree.prototype.onsapright=function(e){this.moveFocus(false);e.preventDefault();};
sap.ui.commons.Tree.prototype.onsaphome=function(e){var d=e.srcElement?e.srcElement:e.target;this.placeFocus(this.getFirstSibling(d));e.preventDefault();};
sap.ui.commons.Tree.prototype.onsaphomemodifiers=function(e){this.placeFocus(this.getFirst());e.preventDefault();};
sap.ui.commons.Tree.prototype.onsapend=function(e){var d=e.srcElement?e.srcElement:e.target;this.placeFocus(this.getLastSibling(d));e.preventDefault();};
sap.ui.commons.Tree.prototype.onsapendmodifiers=function(e){this.placeFocus(this.getLast());e.preventDefault();};
sap.ui.commons.Tree.prototype.onsapcollapseall=function(e){if(this.bAllCollapsed){this.expandAll();}else{this.collapseAll();}this.bAllCollapsed=!this.bAllCollapsed;};
sap.ui.commons.Tree.prototype.getFirstSibling=function(d){var a=jQuery(d).siblings(".sapUiTreeNode:visible").first();if(a.length){return a[0];}return null;};
sap.ui.commons.Tree.prototype.getLastSibling=function(d){var a=jQuery(d).siblings(".sapUiTreeNode:visible").last();if(a.length){return a[0];}return null;};
sap.ui.commons.Tree.prototype.getFirst=function(){var d=jQuery.sap.byId(this.getId()).find(".sapUiTreeNode:visible").first();if(d.length){return d[0];}return null;};
sap.ui.commons.Tree.prototype.getLast=function(){var d=jQuery.sap.byId(this.getId()).find(".sapUiTreeNode:visible").last();if(d.length){return d[0];}return null;};
sap.ui.commons.Tree.prototype.moveFocus=function(m){var a=jQuery(".sapUiTreeNode:focus");if(a.length){var c=sap.ui.getCore().getControl(a[0].id);var d=jQuery.sap.byId(this.getId()).find(".sapUiTreeNode:visible");var b=d.index(a[0]);var n=b;if(m){n--;}else{n++;}if(n>=0&&n<d.length){var o=d.eq(n);var e=sap.ui.getCore().getControl(o[0].id);c.blur();e.focus();}}};
sap.ui.commons.Tree.prototype.adjustFocus=function(){var f=jQuery.sap.byId(this.getId()).find('.sapUiTreeNode[tabIndex="0"]');if(!f.is(':visible')){var d=jQuery.sap.byId(this.getId()).find(".sapUiTreeNode");var a=d.index(f[0]);var b=d.filter(":lt("+a+")");var c=b.filter(":visible");var n=c[c.length-1];n.setAttribute("tabindex","0");if(jQuery(".sapUiTreeNode:focus").is(":not(:visible)")){n.focus();}}};
sap.ui.commons.Tree.prototype.placeFocus=function(d){if(!d){return;}var o=jQuery.sap.byId(this.getId()).find(".sapUiTreeNode[tabIndex='0']");if(o.length){o[0].setAttribute("tabindex","-1");}d.setAttribute("tabindex","0");var t=sap.ui.getCore().getControl(d.id);t.focus();};
sap.ui.commons.Tree.prototype.adjustSelectionOnExpanding=function(e){var t=this.$(),$=jQuery(e),d,a;if($.hasClass("sapUiTreeNodeSelectedParent")){$.removeClass("sapUiTreeNodeSelectedParent");}var b=t.find(".sapUiTreeNodeSelected:visible");if(b.length){t.find(".sapUiTreeNodeSelectedParent").removeClass("sapUiTreeNodeSelectedParent");}else{d=t.find(".sapUiTreeNodeSelected");a=d.parent(".sapUiTreeChildrenNodes").prev(".sapUiTreeNode");while(a.length&&!a.is(":visible")){a=a.parent(".sapUiTreeChildrenNodes").prev(".sapUiTreeNode");}a.addClass("sapUiTreeNodeSelectedParent");}};
sap.ui.commons.Tree.prototype.adjustSelectionOnCollapsing=function(d){var $=jQuery(d),c="#"+$.attr("id")+"-children",a=$.siblings(c).find(".sapUiTreeNodeSelected"),b=$.siblings(c).find(".sapUiTreeNodeSelectedParent");if(a.length||b.length){$.addClass("sapUiTreeNodeSelectedParent");if(b.length){b.removeClass("sapUiTreeNodeSelectedParent");}}};
sap.ui.commons.Tree.prototype.isTreeBinding=function(n){return(n=="nodes");};
sap.ui.commons.Tree.prototype.updateNodes=function(b){var o=b.binding,t=b.template,c=o.getRootContexts(),s=this.oSelectedContext;this.oSelectedNode=null;this.oSelectedContext=null;this.updateNodesRecursively(c,t,o,s,this);};
sap.ui.commons.Tree.prototype.updateNodesRecursively=function(c,t,b,s,p){p.destroyNodes();var n=p.getNodes();var o,a=this;jQuery.each(c,function(i,d){o=n[i];if(!o){o=t.clone(d.replace(/\//g,"-"));}o.setBindingContext(d);p.addNode(o);if(d==s){o.setProperty("isSelected",true,true);a.oSelectedNode=o;a.oSelectedContext=d;}a.updateNodesRecursively(b.getNodeContexts(d),t,b,s,o);});};
sap.ui.commons.Tree.prototype.getSelection=function(){return this.oSelectedNode;};
sap.ui.commons.Tree.prototype.setSelection=function(n){var d;d=this.fireSelect({node:n,nodeContext:n&&n.getBindingContext()});if(d){if(this.oSelectedNode){this.oSelectedNode.deselect();}if(n){n.select();}this.oSelectedNode=n;this.oSelectedContext=n&&n.getBindingContext();}};
