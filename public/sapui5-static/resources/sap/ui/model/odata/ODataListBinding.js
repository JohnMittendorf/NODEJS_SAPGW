/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.ui.model.odata.ODataListBinding");jQuery.sap.require("sap.ui.model.ListBinding");jQuery.sap.require("sap.ui.core.format.DateFormat");
sap.ui.model.odata.ODataListBinding=function(m,p,c,s,f){sap.ui.model.ListBinding.apply(this,arguments);this.sFilterParams=null;this.sSortParams=null;this.sRangeParams=null;this.aPredefinedFilters=f;this.iStartIndex=-1;this.bPendingChange=false;this.aKeys=[];this.bInitialized=false;this.oDateTimeFormat=sap.ui.core.format.DateFormat.getDateInstance({pattern:"'datetime'''yyyy-MM-dd'T'HH:mm:ss''"});this.oDateTimeOffsetFormat=sap.ui.core.format.DateFormat.getDateInstance({pattern:"'datetimeoffset'''yyyy-MM-dd'T'HH:mm:ss'Z'''"});this.createSortParams(s);this.createFilterParams(f);this.iLength=0;this.bLengthFinal=false;if(this.oModel.isCountSupported()){this._getLength();}};
sap.ui.model.odata.ODataListBinding.prototype=jQuery.sap.newObject(sap.ui.model.ListBinding.prototype);
sap.ui.model.odata.ODataListBinding.prototype.getContexts=function(s,l,t){this.bInitialized=true;if(!s){s=0;}if(!l){l=this.oModel.iSizeLimit;}if(this.bLengthFinal){if(s+l>this.iLength){l=this.iLength-s;}if(l<0){l=0;}}var c=[],o;for(var i=s;i<s+l;i++){o=this.aKeys[i];if(!o){break;}c.push(o);}if(t&&(t<=l||c.length===l)){t=undefined;}var a=s;var b=l;if(t){var d=Math.floor(s/(t/2));var a=Math.floor(d*(t/2));var b=this.bLengthFinal?Math.min(this.iLength-a,t):Math.max(l,t);if(!this.bPendingRequest&&b>0){this.loadData(a,b);}}else{if(!this.bPendingRequest&&l>0&&c.length!=l){this.loadData(s,l);}}return c;};
sap.ui.model.odata.ODataListBinding.prototype.setContext=function(c){if(this.oContext!=c){this.oContext=c;if(this.bInitialized){this.aKeys=[];this.loadData();}}};
sap.ui.model.odata.ODataListBinding.prototype.loadData=function(s,l,b){var t=this;this.bPendingRequest=true;var c=undefined;if(arguments.length===1&&typeof s==="function"){c=s;s=undefined;}if(s||l){this.sRangeParams="$skip="+s+"&$top="+l;this.iStartIndex=s;}else{s=this.iStartIndex;}var p=[];if(this.sRangeParams){p.push(this.sRangeParams);}if(this.sSortParams){p.push(this.sSortParams);}if(this.sFilterParams){p.push(this.sFilterParams);}p.push("$inlinecount=allpages");function _(d){jQuery.each(d.results,function(i,e){t.aKeys[s+i]=t.oModel._getKey(e);});if(d.__count){t.iLength=parseInt(d.__count,10);t.bLengthFinal=true;}if(t.iLength<s+d.results.length){t.iLength=s+d.results.length;t.bLengthFinal=false;}if(d.results.length<l){t.iLength=s+d.results.length;t.bLengthFinal=true;}if(d.results.length==0){t.iLength=0;t.bLengthFinal=true;}t.bPendingRequest=false;if(c){c.call(t);}}var o=this.oContext||"",a=this.sPath.indexOf("/")!=0?o+"/"+this.sPath:this.sPath;this.oModel._loadData(a,p,_,function(){if(c){c.call(t);}},this.getContext());};
sap.ui.model.odata.ODataListBinding.prototype.getLength=function(){return this.iLength;};
sap.ui.model.odata.ODataListBinding.prototype._getLength=function(){var t=this;var p=[];if(this.sFilterParams){p.push(this.sFilterParams);}var r=this.oModel._createRequest(this.sPath+"/$count",p,false);function _(d){t.iLength=parseInt(d,10);t.bLengthFinal=true;}function a(x,e,o){jQuery.sap.log.warning("Request for $count failed: "+e,x.responseText+","+x.status+","+x.statusText);}jQuery.ajax({url:r.requestUri,async:r.async,username:r.user,password:r.password,success:_,error:a});};
sap.ui.model.odata.ODataListBinding.prototype.checkUpdate=function(u){this._fireChange();};
sap.ui.model.odata.ODataListBinding.prototype.sort=function(s){this.createSortParams(s);this.aKeys=[];this.loadData(function(){this._fireSort({sorter:s});});};
sap.ui.model.odata.ODataListBinding.prototype.createSortParams=function(s){if(s){this.sSortParams="$orderby="+s.sPath;this.sSortParams+=s.bDescending?"%20desc":"%20asc";}else{this.sSortParams=null;}};
sap.ui.model.odata.ODataListBinding.prototype.filter=function(f){if(!f){f=[];}if(this.aPredefinedFilters){f=f.concat(this.aPredefinedFilters);}this.createFilterParams(f);this.aKeys=[];this.iLength=0;this.bLengthFinal=false;this.loadData(function(){this._fireFilter({filters:f});});};
sap.ui.model.odata.ODataListBinding.prototype.createFilterParams=function(f){if(f&&f.length>0){var s="$filter=((",v,c,l="";f.sort(function(a,b){if(a.sPath<b.sPath){return-1;}else if(b.sPath<a.sPath){return 1;}else{return 0;}});var t=this;jQuery.each(f,function(i,o){if(i>0){if(l!=o.sPath){s+="))%20and%20((";}else{s+=")%20or%20(";}}v=o.oValue1;if(isNaN(v)){if(!isNaN(Date.parse(v))){v=t.oDateTimeFormat.format(new Date(v));}else{v="\'"+v+"\'";}}c=o.oValue2;if(c){if(isNaN(c)){if(!isNaN(Date.parse(c))){c=t.oDateTimeFormat.format(new Date(c));}else{c="\'"+c+"\'";}}}switch(o.sOperator){case"EQ":case"NE":case"GT":case"GE":case"LT":case"LE":s+=o.sPath+"%20"+o.sOperator.toLowerCase()+"%20"+v;break;case"BT":s+=o.sPath+"%20gt%20"+v+"%20and%20"+o.sPath+"%20lt%20"+c;break;case"Contains":s+="indexof("+o.sPath+","+v+")%20ne%20-1";break;case"StartsWith":s+="startswith("+o.sPath+","+v+")%20eq%20true";break;case"EndsWith":s+="endswith("+o.sPath+","+v+")%20eq%20true";break;default:s+="true";}l=o.sPath;});s+="))";this.sFilterParams=s;}else{this.sFilterParams=null;}};
sap.ui.model.odata.ODataListBinding.prototype._refresh=function(){this.aKeys=[];this.bLengthFinal=false;this.checkUpdate();};
