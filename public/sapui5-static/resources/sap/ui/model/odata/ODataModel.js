/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.ui.model.odata.ODataModel");jQuery.sap.require("sap.ui.model.odata.datajs");jQuery.sap.require("sap.ui.model.Model");jQuery.sap.require("sap.ui.model.odata.ODataPropertyBinding");jQuery.sap.require("sap.ui.model.odata.ODataListBinding");
sap.ui.model.odata.ODataModel=function(s,j,u,p){sap.ui.model.Model.apply(this,arguments);this.sDefaultBindingMode=sap.ui.model.BindingMode.OneWay;this.mSupportedBindingModes={"OneWay":true,"OneTime":true,"TwoWay":true};this.bCountSupported=true;this.oRequestQueue=[];this.oHeaders={};this.oData={};this.oMetadata={};if(s.indexOf("?")==-1){this.sServiceUrl=s;}else{var a=s.split("?");this.sServiceUrl=a[0];this.sUrlParams=a[1];}this.sServiceUrl=this.sServiceUrl.replace(/\/$/,"");this.sUser=u;this.sPassword=p;this.oHeaders["x-csrf-token"]="Fetch";this._loadMetadata();if(j){this.oHeaders["Accept"]="application/json";}else{this.oHeaders["Accept"]="application/atom+xml,application/atomsvc+xml,application/xml";}this.oHeaders["MaxDataServiceVersion"]="2.0";};
sap.ui.model.odata.ODataModel.prototype=jQuery.sap.newObject(sap.ui.model.Model.prototype);sap.ui.base.Object.defineClass("sap.ui.model.odata.ODataModel",{baseType:"sap.ui.model.Model",publicMethods:[]});sap.ui.model.odata.ODataModel.M_EVENTS={RejectChange:"rejectChange"};
sap.ui.model.odata.ODataModel.prototype.fireRejectChange=function(a){this.fireEvent("rejectChange",a);return this;};
sap.ui.model.odata.ODataModel.prototype.attachRejectChange=function(d,f,l){this.attachEvent("rejectChange",d,f,l);return this;};
sap.ui.model.odata.ODataModel.prototype.detachRejectChange=function(f,l){this.detachEvent("rejectChange",f,l);return this;};
sap.ui.model.odata.ODataModel.prototype._createRequest=function(p,u,a){var s=this.sServiceUrl;if(p){if(!jQuery.sap.startsWith(p,"/")){s+="/";}s+=p;}if(!u){u=[];}if(this.sUrlParams){u.push(this.sUrlParams);}if(u.length>0){s+="?"+u.join("&");}return{requestUri:s,headers:this.oHeaders,async:a,user:this.sUser,password:this.sPassword};};
sap.ui.model.odata.ODataModel.prototype._loadMetadata=function(){var r=this._createRequest("$metadata",null,false);var t=this;function _(m,o){if(o){t.oHeaders["x-csrf-token"]=o.headers["x-csrf-token"];}t.oMetadata=m;}function a(e){var s="The following problem occurred: "+e.message;if(e.response){s+=e.response.statusCode+","+e.response.statusText+","+e.response.body;}jQuery.sap.log.fatal(s);}OData.read(r,_,a,OData.metadataHandler);};
sap.ui.model.odata.ODataModel.prototype._loadData=function(p,a,s,e,c){var r=this._createRequest(p,a,true);var t=this;function _(o,g){if(!o){jQuery.sap.log.fatal("The following problem occurred: No data was retrieved by service: "+g.requestUri);}f=f.concat(o.results);if(o.__next){r.requestUri=o.__next;d(r);}else{jQuery.extend(o.results,f);if(o.results&&!jQuery.isArray(o.results)){o=o.results;}if(o.results){jQuery.each(o.results,function(i,h){t.oData[t._getKey(h)]=h;});}else{t.oData[t._getKey(o)]=o;}if(s){s(o);}t.sChangeKey=null;t.checkUpdate(c);t.fireRequestCompleted({url:r.requestUri,type:"GET",async:r.async,info:"Accept headers:"+t.oHeaders["Accept"]});}}function b(o){if(e){e();}t.sChangeKey=null;t.checkUpdate(c);var m={},g="The following problem occurred: "+o.message;m.message=o.message;if(o.response){g+=o.response.statusCode+","+o.response.statusText+","+o.response.body;m.statusCode=o.response.statusCode;m.statusText=o.response.statusText;m.responseText=o.response.body;}jQuery.sap.log.fatal(g);t.fireRequestCompleted({url:r.requestUri,type:"GET",async:r.async,info:"Accept headers:"+t.oHeaders["Accept"]});t.fireRequestFailed(m);}function d(g){OData.read(r,_,b,undefined,undefined,t.oMetadata);}var f=[];this.fireRequestSent({url:r.requestUri,type:"GET",async:r.async,info:"Accept headers:"+this.oHeaders["Accept"]});d(r);};
sap.ui.model.odata.ODataModel.prototype.removeData=function(){this.oData={};this.aBindings=[];};
sap.ui.model.odata.ODataModel.prototype.checkUpdate=function(c){var b=this.aBindings.slice(0);jQuery.each(b,function(i,o){if(!c||o.getContext()==c){o.checkUpdate();}});};
sap.ui.model.odata.ODataModel.prototype.bindProperty=function(p,c){var b=new sap.ui.model.odata.ODataPropertyBinding(this,p,c);return b;};
sap.ui.model.odata.ODataModel.prototype.bindList=function(p,c,s,f){var b=new sap.ui.model.odata.ODataListBinding(this,p,c,s,f);return b;};
sap.ui.model.odata.ODataModel.prototype.createBindingContext=function(p,c,f){var d=this._getObject(p,c),t=this;if(d){f(this._getKey(d));}else{var i=!jQuery.sap.startsWith(p,"/");var s=(i&&c?c+"/":"")+p;this._loadData(s,null,function(d){var k=d?t._getKey(d):undefined;if(k&&c&&i){t.oData[c][p]={__ref:k};}f(k);},function(){f();});}};
sap.ui.model.odata.ODataModel.prototype.destroyBindingContext=function(c){};
sap.ui.model.odata.ODataModel.prototype.setCountSupported=function(c){this.bCountSupported=c;};
sap.ui.model.odata.ODataModel.prototype.isCountSupported=function(){return this.bCountSupported;};
sap.ui.model.odata.ODataModel.prototype._getKey=function(e){var u=e.__metadata.uri;return u.substr(u.lastIndexOf("/")+1);};
sap.ui.model.odata.ODataModel.prototype.getProperty=function(p,c){return this._getObject(p,c);};
sap.ui.model.odata.ODataModel.prototype._getObject=function(p,c){var n=this.oData[c];if(c&&!n){return null;}if(!c){n=this.oData;}if(!p){return n;}var a=p.split("/"),i=0;if(!a[0]){n=this.oData;i++;}while(n&&a[i]){n=n[a[i]];if(n){if(n.__ref){n=this.oData[n.__ref];}else if(n.__deferred){n=null;}}i++;}return n;};
sap.ui.model.odata.ODataModel.prototype._refreshXSRFToken=function(){if(this.oHeaders["x-csrf-token"]=="Required"){var h={};jQuery.extend(h,this.oHeaders);this.oHeaders={};this.oHeaders["x-csrf-token"]="Fetch";this._loadMetadata();h["x-csrf-token"]=this.oHeaders["x-csrf-token"];jQuery.extend(this.oHeaders,h);}};
sap.ui.model.odata.ODataModel.prototype.refresh=function(){this._refreshXSRFToken();var b=this.aBindings.slice(0);jQuery.each(b,function(i,o){o._refresh();});};
sap.ui.model.odata.ODataModel.prototype._submitChange=function(r,s,e,h){var t=this;function _(d,o){if(s){s(d,o);}if(t._isDataStored(t.oRequestQueue[0])||t.oRequestQueue[0].method=="POST"){t.sChangeKey=null;t.refresh();}t.oRequestQueue=[];}function a(o){var p={},b="The following problem occurred: "+o.message;p.message=o.message;if(o.response){if(o.response.statusCode=='403'&&o.response.headers["x-csrf-token"]){t.oHeaders["x-csrf-token"]=o.response.headers["x-csrf-token"];}b+=o.response.statusCode+","+o.response.statusText+","+o.response.body;p.statusCode=o.response.statusCode;p.statusText=o.response.statusText;p.responseText=o.response.body;}jQuery.sap.log.fatal(b);if(t._isDataStored(t.oRequestQueue[0])){t.sChangeKey=null;t.refresh();}t.oRequestQueue=[];if(e){e();}}OData.request(r,_,a,h,undefined,this.oMetadata);};
sap.ui.model.odata.ODataModel.prototype.getData=function(p,c){return this._getObject(p,c);};
sap.ui.model.odata.ODataModel.prototype._getChangeUrl=function(p,c){var u;if(c){c=c.replace(/^\/|\/$/g,"");}p=p.replace(/^\/|\/$/g,"");if(c&&p){u=this.sServiceUrl+'/'+c+'/'+p;}else if(!c&&p){u=this.sServiceUrl+'/'+p;}else{u=this.sServiceUrl+'/'+c;}return u;};
sap.ui.model.odata.ODataModel.prototype._createChangeRequest=function(u,p,m,a){var c={};jQuery.extend(c,this.oHeaders);return{headers:c,requestUri:u,method:m,data:p,user:this.sUser,password:this.sPassword,async:a};};
sap.ui.model.odata.ODataModel.prototype._isDataStored=function(r){var p,d;p=r.requestUri.replace(this.sServiceUrl,'');d=this._getObject(p);if(d){return true;}return false;};
sap.ui.model.odata.ODataModel.prototype.update=function(p,d,c,s,e){var r,u;u=this._getChangeUrl(p,c);r=this._createChangeRequest(u,d,"PUT",false);this.oRequestQueue.push(r);this._submitChange(r,s,e);};
sap.ui.model.odata.ODataModel.prototype.create=function(p,d,c,s,e){var r,u;u=this._getChangeUrl(p,c);r=this._createChangeRequest(u,d,"POST",false);this.oRequestQueue.push(r);this._submitChange(r,s,e);};
sap.ui.model.odata.ODataModel.prototype.remove=function(p,c,s,e){var r,u;u=this._getChangeUrl(p,c);r=this._createChangeRequest(u,null,"DELETE",false);this.oRequestQueue.push(r);this._submitChange(r,s,e);};
sap.ui.model.odata.ODataModel.prototype.read=function(p,c,a,b,s,e){var r,u;u=this._getChangeUrl(p,c);r=this._createRequest(u.replace(this.sServiceUrl,''),a,b);OData.read(r,s,e,null,null,this.oMetadata);};
sap.ui.model.odata.ODataModel.prototype.getServiceMetadata=function(){return this.oMetadata;};
sap.ui.model.odata.ODataModel.prototype.submitChanges=function(s,e){var r,p,t=this,a;if(this.sChangeKey){a=this.sChangeKey.replace(this.sServiceUrl,'');p=this._getObject(a);r=this._createChangeRequest(this.sChangeKey,p,"PUT",true);this.oRequestQueue.push(r);function _(d,o){if(s){s(d,o);}t.sChangeKey=null;};function b(o){if(e){e(o);}t.sChangeKey=null;};this._submitChange(r,_,b);}};
sap.ui.model.odata.ODataModel.prototype.resetChanges=function(s,e){var p;if(this.sChangeKey){p=this.sChangeKey.replace(this.sServiceUrl,'');this._loadData(p,null,s,e);}};
sap.ui.model.odata.ODataModel.prototype.setProperty=function(p,v,c){var s,e={},a=this._getChangeUrl(p,c),a=a.substring(0,a.lastIndexOf("/")),o=p.substring(0,p.lastIndexOf("/")),b=false;s=p.substr(p.lastIndexOf("/")+1);e=this._getObject(o,c);if(!this.sChangeKey){this.sChangeKey=a;}if(this.sChangeKey==a){e[s]=v;b=true;}else{this.fireRejectChange({rejectedValue:v,oldValue:e[s]});}return b;};
sap.ui.model.odata.ODataModel.prototype.hasPendingChanges=function(){return this.sChangeKey!=null;};
