/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.ui.ux3.ExactList");jQuery.sap.require("sap.ui.ux3.library");jQuery.sap.require("sap.ui.core.Control");sap.ui.core.Control.extend("sap.ui.ux3.ExactList",{metadata:{library:"sap.ui.ux3",properties:{"showClose":{type:"boolean",group:"Misc",defaultValue:false},"topTitle":{type:"string",group:"Misc",defaultValue:null},"topHeight":{type:"int",group:"Appearance",defaultValue:290}},aggregations:{"subLists":{type:"sap.ui.ux3.ExactList",multiple:true,singularName:"subList"}},associations:{"data":{type:"sap.ui.ux3.ExactAttribute",multiple:false}},events:{"attributeSelected":{},"widthChanged":{}}}});sap.ui.ux3.ExactList.M_EVENTS={'attributeSelected':'attributeSelected','widthChanged':'widthChanged'};(function(){jQuery.sap.require("sap.ui.commons.ListBox");jQuery.sap.require("sap.ui.core.Popup");jQuery.sap.require("jquery.sap.dom");jQuery.sap.require("sap.ui.core.theming.Parameters");sap.ui.ux3.ExactList.getMetadata()._mHiddenAggregations={"controls":{multiple:true,type:"sap.ui.commons.ListBox"}};sap.ui.ux3.ExactList.prototype.init=function(){var r=this;this._iLevel=0;this._bCollapsed=false;this._bIsFirstRendering=true;this._rb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.ux3");this._lb=new sap.ui.commons.ListBox(this.getId()+"-lb",{allowMultiSelect:true,displayIcons:true});this.addAggregation("controls",this._lb);this._lb.invalidate=function(){sap.ui.commons.ListBox.prototype.invalidate.apply(r._lb,arguments);r.invalidate();};var u=this._lb._handleUserActivation;this._lb._handleUserActivation=function(i){i.metaKey=true;u.apply(this,[i]);};this._lb.addDelegate({onclick:function(i){r.onclick(i);},onAfterRendering:function(){var v=r._lb.getItems();var w=r._isTop();var x=false;for(var i=0;i<v.length;i++){var y=v[i];var z=sap.ui.getCore().byId(y.getKey());var A=jQuery.sap.byId(y.getId());A.attr("role","treeitem");if(w){A.addClass("sapUiUx3ExactLstNoIco");x=true;}else if(!z||!z.getShowSubAttributesIndicator_Computed()){A.addClass("sapUiUx3ExactLstNoIco");A.attr("aria-level",""+r._iLevel);x=false;}else{A.attr("aria-haspopup","true");A.attr("aria-level",""+r._iLevel);x=true;}if(x&&A.hasClass("sapUiLbxISel")&&z&&z.getChangeListener()&&z.getChangeListener().id){A.attr(w?"aria-controls":"aria-owns",z.getChangeListener().id+"-lb-list");}}var B=sap.ui.getCore().getConfiguration().getRTL()?"left":"right";jQuery(".sapUiLbxITxt",r._lb.getDomRef()).css("margin-"+B,20+jQuery.sap.scrollbarSize().width+"px");jQuery(".sapUiLbxIIco",r._lb.getDomRef()).css(B,5+jQuery.sap.scrollbarSize().width+"px");jQuery(r._lb.getDomRef()).attr("tabindex","-1");jQuery(r._lb.getFocusDomRef()).attr("aria-label",w?r.getTopTitle():r._getAtt().getText()).attr("role","treeitem");r._lb.oItemNavigation.iActiveTabIndex=-1;}});this._lb.attachSelect(function(i){j(r,i);});this._closeHandle=jQuery.proxy(this.onForceVerticalClose,this);};sap.ui.ux3.ExactList.prototype.exit=function(){m(this);this._lb.removeAllItems();this._lb=null;this._closeHandle=null;this._scrollCheckHandle=null;this._rb=null;this._oTopList=null;if(this._dirtyListsCleanupTimer){jQuery.sap.clearDelayedCall(this._dirtyListsCleanupTimer);this._dirtyListsCleanupTimer=null;this._dirtyLists=null;}};sap.ui.ux3.ExactList.prototype.getFocusDomRef=function(){return this._bCollapsed?jQuery.sap.domById(this.getId()+"-head"):this._lb.getFocusDomRef();};sap.ui.ux3.ExactList.prototype.onBeforeRendering=function(){this._oTopList=null;};sap.ui.ux3.ExactList.prototype.onAfterRendering=function(){this._bRTL=sap.ui.getCore().getConfiguration().getRTL();var i=this;p(this);if(this._isTop()){this._bIsFirstRendering=false;this._iScrollWidthDiff=-1;this.onCheckScrollbar();jQuery.sap.byId(this.getId()+"-lst").css("bottom",jQuery.sap.scrollbarSize().height+"px");}if(!this._iCurrentWidth){this._iCurrentWidth=this._DEFAULTWIDTH;}if(!this._bIsFirstRendering){s(this,this._iCurrentWidth);}if(f(this)){jQuery.sap.byId(this.getId()+"-lst").addClass("sapUiUx3ExactLstLstExp");if(!this._oPopup){var r=function(u){i._handleEvent(u);};this._oPopup=new sap.ui.core.Popup();if(!jQuery.browser.mozilla){this._oPopup._fixPositioning=function(u,v){sap.ui.core.Popup.prototype._fixPositioning.apply(this,arguments);if(v){var $=this._$();var w=jQuery(u.of);var x=0;if(u.offset){x=parseInt(u.offset.split(" ")[0]);}$.css("right",(jQuery(window).width()-w.outerWidth()-w.offset().left+x)+"px");}};}this._oPopup.open=function(){var u=jQuery.sap.byId(i.getId()+"-lst");a(u,false,-1,function(v){u.addClass("sapUiUx3ExactLstExpanded");jQuery.sap.byId(i.getId()+"-exp").html(sap.ui.ux3.ExactListRenderer.getExpanderSymbol(true,false));i.__sOldHeight=u.css("height");u.css("height",i.__sOldHeight);var w=jQuery.sap.byId(i.getId()+"-head");var x=jQuery(i._lb.getDomRef());var y=x[0].scrollHeight+jQuery.sap.byId(i.getId()+"-exp").height()+x.outerHeight()-x.height()+1;var z=jQuery(window).height()-parseInt(x.offset().top,10)+jQuery(window).scrollTop()-w.outerHeight();var A=Math.min(y,z);i._oPopup.setContent(u[0]);var B=sap.ui.core.theming.Parameters.get()["sap.ui.ux3.ExactList:sapUiUx3ExactLst"+(i._isTop()?"Root":"")+"ExpandOffset"]||"0 0";sap.ui.core.Popup.prototype.open.apply(i._oPopup,[0,sap.ui.core.Popup.Dock.BeginTop,sap.ui.core.Popup.Dock.BeginBottom,w[0],B,"none none"]);i._bPopupOpened=true;return A;},function(v){f(i);i.getFocusDomRef().focus();jQuery.sap.bindAnyEvent(i._closeHandle);v.bind(jQuery.sap.ControlEvents.join(" "),r);});};this._oPopup.close=function(u){var v=jQuery.sap.byId(i.getId()+"-lst");a(v,false,i.__sOldHeight,function(w){jQuery.sap.unbindAnyEvent(i._closeHandle);w.unbind(jQuery.sap.ControlEvents.join(" "),r);v.removeClass("sapUiUx3ExactLstExpanded");jQuery.sap.byId(i.getId()+"-exp").html(sap.ui.ux3.ExactListRenderer.getExpanderSymbol(false,false));},function(w){w.detach();v.removeClass("sapUiShd");w.attr("style","width:"+i._iCurrentWidth+"px;");jQuery(i.getDomRef()).prepend(w);i._oPopup.setContent(null);i._bPopupOpened=undefined;i.__sOldHeight=null;if(i._isTop()){w.css("bottom",jQuery.sap.scrollbarSize().height+"px");}f(i);sap.ui.core.Popup.prototype.close.apply(i._oPopup,[0]);if(!u){i.getFocusDomRef().focus();}});};}}e(this);if(this._bIsFirstRendering){this._bIsFirstRendering=false;a(jQuery(this.getDomRef()),true,0,function(u){u.css("overflow","hidden").css("width","0px");return u[0].scrollWidth;},function(u){u.css("overflow","").css("width","");s(i,i._iCurrentWidth);});}};sap.ui.ux3.ExactList.prototype.onfocusin=function(i){if(i.target===this.getDomRef()){this.getFocusDomRef().focus();}if(this._isTop()){jQuery(this.getDomRef()).attr("tabindex","-1");}if(!i.__exactHandled){jQuery.sap.byId(this.getId()+"-head").addClass("sapUiUx3ExactLstHeadFocus");i.__exactHandled=true;}};sap.ui.ux3.ExactList.prototype.onfocusout=function(i){if(this._isTop()){jQuery(this.getDomRef()).attr("tabindex","0");}jQuery.sap.byId(this.getId()+"-head").removeClass("sapUiUx3ExactLstHeadFocus");};sap.ui.ux3.ExactList.prototype.onclick=function(i){if(jQuery(i.target).attr("id")==this.getId()+"-exp"){g(this);this.focus();}else if(jQuery(i.target).attr("id")==this.getId()+"-close"){h(this);}else if(jQuery(i.target).attr("id")==this.getId()+"-hide"){t(this);}else if(!jQuery.sap.containsOrEquals(jQuery.sap.byId(this.getId()+"-cntnt")[0],i.target)){this.focus();}};sap.ui.ux3.ExactList.prototype.onkeydown=function(i){switch(i.keyCode){case jQuery.sap.KeyCodes.DELETE:if(!this._isTop()&&this.getShowClose()){this.getParent()._handleTab(this,{shiftKey:true,preventDefault:function(){},stopPropagation:function(){}});h(this);i.preventDefault();i.stopPropagation();}break;case jQuery.sap.KeyCodes.NUMPAD_MINUS:if(!!(i.metaKey||i.ctrlKey)){}else if(i.shiftKey){if(!this._bCollapsed){s(this,this._iCurrentWidth-10);i.preventDefault();i.stopPropagation();}}else if(!this._bCollapsed){if(!this._isTop()){t(this);i.preventDefault();i.stopPropagation();}}break;case jQuery.sap.KeyCodes.NUMPAD_PLUS:if(!!(i.metaKey||i.ctrlKey)){}else if(i.shiftKey){if(!this._bCollapsed){s(this,this._iCurrentWidth+10);i.preventDefault();i.stopPropagation();}}else if(this._bCollapsed){if(!this._isTop()){t(this);i.preventDefault();i.stopPropagation();}}break;case jQuery.sap.KeyCodes.TAB:if(jQuery.sap.containsOrEquals(this.getFocusDomRef(),i.target)){if(i.shiftKey){if(!this._isTop()){this.getParent()._handleTab(this,i);}}else{if(this.getSubLists().length==0||this._bCollapsed){if(!this._isTop()){this.getParent()._handleTab(this,i);}}else{this.getSubLists()[0].focus();i.preventDefault();i.stopPropagation();}}}break;}};sap.ui.ux3.ExactList.prototype.onmousedown=function(i){if(i.target.id===this.getId()+"-rsz"){jQuery(document.body).append("<div id=\""+this.getId()+"-ghost\" class=\"sapUiUx3ExactLstRSzGhost\" style =\" z-index:"+sap.ui.core.Popup.getNextZIndex()+"\" ></div>");jQuery(document.body).bind("selectstart",o);jQuery.sap.byId(this.getId()+"-ghost").bind("mouseup",jQuery.proxy(c,this)).bind("mousemove",jQuery.proxy(b,this));this._iStartDragX=i.pageX;this._iStartWidth=jQuery.sap.byId(this.getId()+"-lst").width();jQuery.sap.byId(this.getId()+"-rsz").addClass("sapUiUx3ExactLstRSzDrag");}};sap.ui.ux3.ExactList.prototype.onForceVerticalClose=function(i){if(i.type=="mousedown"||i.type=="click"||i.type=="dblclick"||i.type=="focusin"||i.type=="focusout"||i.type=="keydown"||i.type=="keypress"||i.type=="keyup"||i.type=="mousedown"||i.type=="mouseup"){var r=jQuery.sap.byId(this.getId()+"-lst");if(!jQuery.sap.containsOrEquals(r[0],i.target)||i.target.tagName=="BODY"){if(r.hasClass("sapUiUx3ExactLstExpanded")){this._oPopup.close(true);}}}};sap.ui.ux3.ExactList.prototype.onCheckScrollbar=function(i){this._scrollCheckTimer=null;var r=jQuery.sap.byId(this.getId()+"-cntnt");var u=r[0];if(u){var v=u.scrollWidth-u.clientWidth;if(this._iScrollWidthDiff!=v){this._iScrollWidthDiff=v;if(v<=0){r.css({"overflow-x":"hidden","bottom":jQuery.sap.scrollbarSize().height+"px"});}else{r.css({"overflow-x":"scroll","bottom":"0px"});}}this._scrollCheckTimer=jQuery.sap.delayedCall(300,this,this.onCheckScrollbar);}};sap.ui.ux3.ExactList.prototype.insertSubList=function(i,r){this.insertAggregation("subLists",i,r);if(i){i._iLevel=this._iLevel+1;}return this;};sap.ui.ux3.ExactList.prototype.addSubList=function(i){this.addAggregation("subLists",i);if(i){i._iLevel=this._iLevel+1;}return this;};sap.ui.ux3.ExactList.prototype.setData=function(v){if(v!=null&&typeof(v)!="string"){v=v.getId();}if(v){this.setAssociation("data",v);v=this._getAtt();this._lb.removeAllItems();var r=v.getAttributesInternal(true);var u=[];var w=[];for(var i=0;i<r.length;i++){var x=q(r[i]);this._lb.addItem(x);if(r[i].getSelected()){var y=k(this,r[i]);if(y){w.push(y);}u.push(x.getKey());}}this._lb.setSelectedKeys(u);var z=this.getSubLists();for(var i=0;i<z.length;i++){var A=jQuery.inArray(z[i],w);if(A>=0){w.splice(A,1);}else{z[i]._lb.removeAllItems();z[i].destroy();}}for(var i=0;i<w.length;i++){this.addSubList(w[i]);}var B=this;v.setChangeListener({id:B.getId(),_notifyOnChange:function(C,D){var E=n(B);if(!E._dirtyLists){E._dirtyLists={};}if(!E._dirtyLists[B.getId()]){E._dirtyLists[B.getId()]=B;}if(!E._dirtyListsCleanupTimer){E._dirtyListsCleanupTimer=jQuery.sap.delayedCall(0,E,function(){this._dirtyListsCleanupTimer=null;jQuery.each(this._dirtyLists,function(i,y){if(!y._isTop()){y.getParent().setData(y.getParent().getData());}else{y.setData(y.getData());}});this._dirtyLists=null;},[]);}}});}return this;};sap.ui.ux3.ExactList.prototype.setShowClose=function(i){if(this._isTop()){this.setProperty("showClose",i);}return this;};sap.ui.ux3.ExactList.prototype.getShowClose=function(){return n(this).getProperty("showClose");};sap.ui.ux3.ExactList.prototype.getTopTitle=function(){var i=this.getProperty("topTitle");return i?i:this._rb.getText("EXACT_BRWSR_LST_TITLE");};sap.ui.ux3.ExactList.prototype._getAtt=function(){return sap.ui.getCore().byId(this.getData());};sap.ui.ux3.ExactList.prototype._isTop=function(){return!(this.getParent()instanceof sap.ui.ux3.ExactList);};sap.ui.ux3.ExactList.prototype._handleTab=function(i,r){var u=this.indexOfSubList(i);if(r.shiftKey){if(u>0){this.getSubLists()[u-1].focus();}else{this.focus();}r.preventDefault();r.stopPropagation();}else{if(u<this.getSubLists().length-1){this.getSubLists()[u+1].focus();r.preventDefault();r.stopPropagation();}else if(!this._isTop()){this.getParent()._handleTab(this,r);}}};sap.ui.ux3.ExactList.prototype._selectionChanged=function(i){if(!this._isTop()){return;}var _=function(w,x){if(!w.getSelected()){return;}x.push(w);var y=w.getAttributesInternal();for(var v=0;v<y.length;v++){_(y[v],x);}};var r=[];var u=this._getAtt().getAttributesInternal();for(var v=0;v<u.length;v++){_(u[v],r);}this.fireAttributeSelected({attribute:i,allAttributes:r});};sap.ui.ux3.ExactList.prototype._closeAll=function(){if(!this._isTop()){return;}var r=this;var u=function(){r._getAtt()._clearSelection();r._lb.clearSelection();r.fireAttributeSelected({attribute:undefined,allAttributes:[]});};var v=this.getSubLists();if(v.length>0){for(var i=0;i<v.length;i++){h(v[i],true,i==v.length-1?u:null);}}else{u();}};var a=function(r,w,v,i,u){if(i){var x=i(r);if(x!=undefined){v=x;}}var _=u?function(){u(r);}:function(){};if(jQuery.fx.off){if(w){r.width(v);}else{r.height(v);}_();}else{var y=w?{width:v}:{height:v};r.stop(true,true).animate(y,200,'linear',_);}};var o=function(i){i.preventDefault();i.stopPropagation();return false;};var b=function(i){var r=i.pageX;var u=this._bRTL?(this._iStartDragX-r):(r-this._iStartDragX);s(this,this._iStartWidth+u);};var c=function(i){jQuery(document.body).unbind("selectstart",o);jQuery.sap.byId(this.getId()+"-ghost").remove();jQuery.sap.byId(this.getId()+"-rsz").removeClass("sapUiUx3ExactLstRSzDrag");this._iStartWidth=undefined;this._iStartDragX=undefined;};var d=function(i,w){var r=i._DEFAULTWIDTH-100;var u=i._DEFAULTWIDTH+200;if(w<r){return r;}else if(w>u){return u;}return w;};var s=function(i,w){w=d(i,w);var r=i._bRTL?"right":"left";var u=i.getId();i._iCurrentWidth=w;jQuery.sap.byId(u+"-lst").css("width",w+"px");jQuery.sap.byId(u+"-rsz").css(r,(w-4)+"px");if(i._isTop()){jQuery.sap.byId(u+"-head").css("width",w+"px");jQuery.sap.byId(u+"-cntnt").css(r,(w+8)+"px");jQuery.sap.byId(u+"-scroll").css(r,(w+8)+"px");}else{jQuery.sap.byId(u+"-cntnt").css("margin-"+r,w+"px");}if(i._isTop()){i.fireWidthChanged({width:w+"px"});}};var e=function(i){var r=i._getAtt();if(r&&!i._isTop()){jQuery.sap.byId(i.getId()+"-head-txt").html(jQuery.sap.encodeHTML(r.getText())+"<span class=\"sapUiUx3ExactLstHeadInfo\">&nbsp;("+i._lb.getSelectedIndices().length+"/"+i._lb.getItems().length+")</span>");}};var f=function(i){if(i._lb){var r=jQuery(i._lb.getDomRef());jQuery.sap.byId(i.getId()+"-lst").removeClass("sapUiUx3ExactLstScroll");if(r.outerHeight()<r[0].scrollHeight){jQuery.sap.byId(i.getId()+"-lst").addClass("sapUiUx3ExactLstScroll");return true;}}return false;};var t=function(i){if(i._bCollapsed){a(jQuery(i.getDomRef()),true,0,function(r){r.css("overflow","hidden").css("width","25px").removeClass("sapUiUx3ExactLstCollapsed");jQuery.sap.byId(i.getId()+"-head-txt").width("auto");return r[0].scrollWidth;},function(r){r.css("overflow","").css("width","");jQuery.sap.byId(i.getId()+"-hide").html(sap.ui.ux3.ExactListRenderer.getExpanderSymbol(true,true));i._bCollapsed=!i._bCollapsed;i.focus();});}else{a(jQuery(i.getDomRef()),true,25,null,function(r){r.addClass("sapUiUx3ExactLstCollapsed");jQuery.sap.byId(i.getId()+"-head-txt").width(jQuery.sap.byId(i.getId()+"-head").height()-jQuery.sap.byId(i.getId()+"-head-action").height()-20);r.css("overflow","").css("width","");jQuery.sap.byId(i.getId()+"-hide").html(sap.ui.ux3.ExactListRenderer.getExpanderSymbol(false,true));i._bCollapsed=!i._bCollapsed;i.focus();});}};var g=function(i){var r=jQuery.sap.byId(i.getId()+"-lst");if(r.hasClass("sapUiUx3ExactLstExpanded")){i._oPopup.close();}else{i._oPopup.open();}};var h=function(i,r,u){var v=function(x){if(!r){var y=i._getAtt();var z=y.getParent().indexOfAttribute(y);l(i.getParent(),y,z,true);e(i.getParent());n(i)._selectionChanged(y);}i.destroy();if(u){u();}};var w=i.getDomRef();if(w){a(jQuery(w),true,0,function(x){x.css("overflow","hidden");},v);}else{v();}};var j=function(i,r){e(i);var u=r.getParameter("selectedItem").getKey();var v=sap.ui.getCore().byId(u);var w=r.getParameter("selectedIndex");if(i._lb.isIndexSelected(w)){v.setProperty("selected",true,true);var x=k(i,v);if(x){i.addSubList(x);}}else{l(i,v,w);}n(i)._selectionChanged(v);};var k=function(i,r){if(r.getSelected()){var u=r.getAttributesInternal(true);if(u.length>0){var v;if(r.getChangeListener()){v=sap.ui.getCore().byId(r.getChangeListener().id);}else{v=new sap.ui.ux3.ExactList();}v.setData(r);return v;}}return null;};var l=function(r,u,v,w){r._lb.removeSelectedIndex(v);u._clearSelection();if(!w){var x=r.getSubLists();for(var i=0;i<x.length;i++){if(x[i].getData()===u.getId()){h(x[i],true);}}}};var m=function(i){var r=i._getAtt();if(r&&r.getChangeListener()&&r.getChangeListener().id===i.getId()){r.setChangeListener(null);}};var n=function(i){if(i._isTop()){return i;}if(!i._oTopList){i._oTopList=n(i.getParent());}return i._oTopList;};var p=function(i){i._DEFAULTWIDTH=168;var r=i._isTop()?i.getParent():i._getAtt();if(!r){return;}var w=r.data("__ExactListWidth");if(typeof(w)==="number"&&w>=130&&w<=400){i._DEFAULTWIDTH=Math.floor(w);}};var q=function(i){var r;if(i.__oItem){r=i.__oItem;if(r.getText()!=i.getText()){r.setText(i.getText());}if(r.getKey()!=i.getId()){r.setKey(i.getId());}}else{r=new sap.ui.core.ListItem({text:i.getText(),key:i.getId()});i.exit=function(){if(sap.ui.ux3.ExactAttribute.prototype.exit){sap.ui.ux3.ExactAttribute.prototype.exit.apply(i,[]);}this.__oItem.destroy();this.__oItem=null;};i.__oItem=r;}return r;};}());
