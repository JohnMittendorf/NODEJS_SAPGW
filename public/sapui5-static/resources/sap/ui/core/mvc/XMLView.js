/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.ui.core.mvc.XMLView");jQuery.sap.require("sap.ui.core.library");jQuery.sap.require("sap.ui.core.mvc.View");sap.ui.core.mvc.View.extend("sap.ui.core.mvc.XMLView",{metadata:{library:"sap.ui.core"}});jQuery.sap.require("jquery.sap.xml");jQuery.sap.require("sap.ui.base.DataType");jQuery.sap.require("sap.ui.model.resource.ResourceModel");(function(){sap.ui.xmlview=function(i,v){var s={};if(v){if(typeof(v)=="string"){s.viewName=v;}else{s.viewName=v.viewName;s.controller=v.controller;s.viewContent=v.viewContent;}return new sap.ui.core.mvc.XMLView(i,s);}else{if(typeof(i)=="string"){s.viewName=i;}else{s.viewName=i.viewName;s.controller=i.controller;s.viewContent=i.viewContent;}return new sap.ui.core.mvc.XMLView(s);}};sap.ui.core.mvc.XMLView.prototype.initViewSettings=function(s){if(!s){throw new Error("mSettings must be given");}if(s.viewName&&s.viewContent){throw new Error("View name and view content are given. There is no point in doing this, so please decide.");}else if((s.viewName||s.viewContent)&&s.xmlNode){throw new Error("View name/content AND an XML node are given. There is no point in doing this, so please decide.");}else if(!(s.viewName||s.viewContent)&&!s.xmlNode){throw new Error("Neither view name/content nor an XML node is given. One of them is required.");}if(s.viewName){this._xContent=l(s.viewName);}else if(s.viewContent){this.mProperties["viewContent"]=s.viewContent;this._xContent=jQuery.sap.parseXML(s.viewContent);if(this._xContent.parseError.errorCode!=0){var o=this._xContent.parseError;throw new Error("The following problem occurred: XML parse Error for "+o.url+" code: "+o.errorCode+" reason: "+o.reason+" src: "+o.srcText+" line: "+o.line+" linepos: "+o.linepos+" filepos: "+o.filepos);}else{this._xContent=this._xContent.documentElement;}}else if(s.xmlNode){this._xContent=s.xmlNode;}else{}this._oContainingView=s.containingView||this;if(!this.isSubView()){b(this._xContent,this,s);}else{delete s.controller;}if(this._resourceBundleName||this._resourceBundleUrl){var m=new sap.ui.model.resource.ResourceModel({bundleName:this._resourceBundleName,bundleUrl:this._resourceBundleUrl,bundleLocale:this._resourceBundleLocale});this.setModel(m,this._resourceBundleAlias);}};sap.ui.core.mvc.XMLView.prototype.onControllerConnected=function(o){var t=this;sap.ui.core.Element.runWithPreprocessors(function(){t._aParsedContent=c(t._xContent,t);})};sap.ui.core.mvc.XMLView.prototype.getControllerName=function(){return this._controllerName;};sap.ui.core.mvc.XMLView.prototype.isSubView=function(){return this._oContainingView!=this;};sap.ui.core.mvc.XMLView.prototype.onAfterRendering=function(){if(this._$oldContent.length!==0){var d=this.getAggregation("content");if(d){for(var i=0;i<d.length;i++){var $=d[i].$();jQuery.sap.byId("sap-ui-dummy-"+d[i].getId(),this._$oldContent).replaceWith($);}}jQuery.sap.byId("sap-ui-dummy-"+this.getId()).replaceWith(this._$oldContent);}this._$oldContent=undefined;sap.ui.core.mvc.View.prototype.onAfterRendering.apply(this,arguments);};function l(t){var u=jQuery.sap.getModulePath(t,".view.xml");var r=jQuery.sap.sjax({url:u,dataType:'xml'});var _=r.data;if(!_){throw new Error("View definition could not be loaded from "+u+". Check for XML errors or 'file not found' errors.");}return _.documentElement;}function p(t,v,n){if(v&&v.slice(0,1)==='{'&&v.slice(-1)==='}'){return v;}var o=sap.ui.base.DataType.getType(t);if(o){if(o instanceof sap.ui.base.DataType){return o.parseValue(v);}}else{throw new Error("Property "+n+" has no known type");}return v;}function a(x){return x.localName||x.baseName||x.nodeName;}function b(x,v,s){var m=v.getMetadata().getAllProperties();for(var i=0;i<x.attributes.length;i++){var d=x.attributes[i];if(d.name==='controllerName'){v._controllerName=d.value;}else if(d.name==='resourceBundleName'){v._resourceBundleName=d.value;}else if(d.name==='resourceBundleUrl'){v._resourceBundleUrl=d.value;}else if(d.name==='resourceBundleLocale'){v._resourceBundleLocale=d.value;}else if(d.name==='resourceBundleAlias'){v._resourceBundleAlias=d.value;}else if(!s[d.name]&&m[d.name]){s[d.name]=p(m[d.name].type,d.value,d.name);}}}function c(x,v){var r=[];if(v.isSubView()){d(x,true);}else{e(x);}return r;function d(x,j){if(x.nodeType===1){var s=a(x);if(x.namespaceURI==="http://www.w3.org/1999/xhtml"||x.namespaceURI==="http://www.w3.org/2000/svg"){r.push("<"+s+" ");var k;for(var i=0;i<x.attributes.length;i++){var m=x.attributes[i];var n=m.value;if(m.name==="id"){n=v._oContainingView.createId(n);}r.push(m.name+"='"+n+"' ");}if(j===true){r.push("data-sap-ui-preserve"+"='"+v.getId()+"' ");}r.push(">");e(x);r.push("</"+s+">");}else{var o=h(x);v.addAggregation("content",o);r.push(o);}}else if(x.nodeType===3){var t=x.textContent||x.text;if(t){r.push(t);}}}function e(x,j){var k=x.childNodes;for(var i=0;i<k.length;i++){d(k[i],j);}}function f(n,s){var i;var m=sap.ui.getCore().getLoadedLibraries();jQuery.each(m,function(j,o){if(n===o.namespace||n===o.name){i=o.name+"."+((o.tagNames&&o.tagNames[s])||s);}});i=i||n+"."+s;jQuery.sap.require(i);return jQuery.sap.getObject(i);}function g(n){if(n.namespaceURI==="http://www.w3.org/1999/xhtml"||n.namespaceURI==="http://www.w3.org/2000/svg"){return new sap.ui.core.mvc.XMLView({id:x.attributes['id']?v.createId(x.attributes['id']):undefined,xmlNode:n,containingView:v._oContainingView});}else{return h(n);}}function h(n){var j=n.namespaceURI,o=f(j,a(n)),m=o.getMetadata(),k=m.getJSONKeys(),s={},q="",t=[];for(var i=0;i<n.attributes.length;i++){var u=n.attributes[i];var w=u.name;var y=u.value;var z=k[w];if(w==="id"){s[w]=v.createId(y);}else if(w==="class"){q+=y+" ";}else if(w==="viewName"){s[w]=y;}else if(w.indexOf(":")>-1){if(u.namespaceURI==="http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1"){t.push({Type:"sap.ui.core.CustomData",key:a(u),value:y});}else{jQuery.sap.log.warning("XMLView parser encountered and ignored attribute '"+w+"' (value: '"+y+"') with unknown namespace");}}else if(z&&z._iKind===0){s[w]=p(z.type,y,w);}else if(z&&z._iKind===1&&z.altTypes){s[w]=p(z.altTypes[0],y,w);}else if(z&&z._iKind===2){if(y&&y.slice(0,1)==='{'&&y.slice(-1)==='}'){s[w]={path:y.slice(1,-1),template:null};}}else if(z&&z._iKind===3){s[w]=v.createId(y);}else if(z&&z._iKind===5){var A=v._oContainingView.oController[y];if(A){s[w]=[A,v._oContainingView.oController];}}else{jQuery.sap.log.warning("XMLView parser encountered and ignored unknown attribute '"+w+"' (value: '"+y+"')");}}if(t.length>0){s["customData"]=t;}function B(n,D,E){var F,G,C;for(F=n.firstChild;F;F=F.nextSibling){if(F.nodeType===1){G=F.namespaceURI===j&&E&&E[a(F)];if(G){B(F,G);}else if(D){var C=g(F);if(C){var H=D._sName;if(D.multiple){if(!s[H]){s[H]=[];}if(typeof s[H].path==="string"){s[H].template=C;}else{s[H].push(C);}}else{s[H]=C;}}}else{throw new Error("Cannot add direct child without default aggregation defined for control "+m.getElementName());}}else if(F.nodeType===3){if(jQuery.trim(F.textContent||F.text)){throw new Error("Cannot add text nodes as direct child of an aggregation. For adding text to an aggregation, a surrounding html tag is needed");}}}}B(n,m.getDefaultAggregation(),m.getAllAggregations());var C=new o(s);if(q&&C.addStyleClass){C.addStyleClass(q);}return C;}}}());
