/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.ui.core.support.plugins.ControlTree");jQuery.sap.require("sap.ui.core.support.Plugin");(function(){sap.ui.core.support.Plugin.extend("sap.ui.core.support.plugins.ControlTree",{constructor:function(s){sap.ui.core.support.Plugin.apply(this,["sapUiSupportControlTree","Control Tree",s]);this._oStub=s;if(this.isToolPlugin()){this._aEventIds=[this.getId()+"Entry","sapUiSupportSelectorSelect","sapUiSupportControlProperties"];}else{this._aEventIds=["sapUiSupportRequestControlProperties","sapUiSupportControlPropertyChange"];var t=this;sap.ui.getCore().registerPlugin({startPlugin:function(c){t.oCore=c;},stopPlugin:function(){t.oCore=undefined;}});}}});function i(s){this.$().find("li img.sapUiControlTreeIcon").live("click",jQuery.proxy(this._onIconClick,this));this.$().find("li span").live("click",jQuery.proxy(this._onNodeClick,this));this.$().find("[data-sap-ui-name]").live("change",jQuery.proxy(this._onPropertyChange,this));};function a(s){if(JSON){var u=this.oCore.mUIAreas;var c=[];function b(e){var m={id:e.getId(),type:"",aggregation:[],association:[]};if(e instanceof sap.ui.core.UIArea){m.library="sap.ui.core";m.type="sap.ui.core.UIArea";jQuery.each(e.getContent(),function(k,e){var l=b(e);m.aggregation.push(l);});}else{m.library=e.getMetadata().getLibraryName();m.type=e.getMetadata().getElementName();if(e.mAggregations){for(var d in e.mAggregations){var o=e.mAggregations[d];if(o){var f=jQuery.isArray(o)?o:[o];jQuery.each(f,function(k,v){if(v instanceof sap.ui.core.Element){var l=b(v);m.aggregation.push(l);}});}}}if(e.mAssociations){for(var g in e.mAssociations){var h=e.mAssociations[g];if(h){var j=jQuery.isArray(h)?h:[h];jQuery.each(j,function(k,v){m.association.push(v);});}}}}return m;};jQuery.each(this.oCore.mUIAreas,function(d,o){var e=b(o);c.push(e);});s.sendEvent(this.getId()+"Entry",{controlTree:JSON.stringify(c)});}};sap.ui.core.support.plugins.ControlTree.prototype.init=function(s){sap.ui.core.support.Plugin.prototype.init.apply(this,arguments);if(this.isToolPlugin()){i.call(this,s);}else{a.call(this,s);}};sap.ui.core.support.plugins.ControlTree.prototype.exit=function(s){sap.ui.core.support.Plugin.prototype.exit.apply(this,arguments);if(this.isToolPlugin()){this.$().find("li img.sapUiControlTreeIcon").die();this.$().find("li span").die();}};sap.ui.core.support.plugins.ControlTree.prototype.onsapUiSupportControlTreeEntry=function(e){var t=this;var c=JSON.parse(e.getParameter("controlTree"));function r(m,b){var h=m.aggregation.length>0||m.association.length>0;b.write("<li id=\"sap-debug-controltree-"+m.id+"\" class=\"sapUiControlTreeElement\">");var s=h?"minus":"space";b.write("<img class=\"sapUiControlTreeIcon\" style=\"height: 12px; width: 12px;\" align=\"middle\" src=\"../../../../testsuite/images/"+s+".gif\" />");var p=m.library.replace(/\./g,"/")+"/images/controls/"+m.type+".gif";b.write("<img style=\"height: 16px; width: 16px;\" align=\"middle\" src=\"../../../../../test-resources/"+p+"\" />");var d=m.type.lastIndexOf(".")>0?m.type.substring(m.type.lastIndexOf(".")+1):m.type;b.write("<span title=\""+m.type+"\">"+d+" - "+m.id+"</span>");if(m.aggregation.length>0){b.write("<ul>");jQuery.each(m.aggregation,function(f,v){r(v,b);});b.write("</ul>");}if(m.association.length>0){b.write("<ul>");jQuery.each(m.association,function(f,v){b.write("<li id=\"sap-debug-controltreelink-"+v+"\" class=\"sapUiControlTreeLink\">");b.write("<img style=\"height: 12px; width: 12px;\" align=\"middle\" src=\"../../../../testsuite/images/space.gif\" />");b.write("<img style=\"height: 12px; width: 12px;\" align=\"middle\" src=\"../../../../testsuite/images/link.gif\" />");b.write("<span title='Association to \""+v+"\"'>"+v+"</span>");b.write("</li>");});b.write("</ul>");}b.write("</li>");}var b=sap.ui.getCore().createRenderManager();b.write("<div id=\"sapUiSupportControlTreeArea\"><ul>");jQuery.each(c,function(d,v){r(v,b);});b.write("</ul></div><div id=\"sapUiSupportControlPropertiesArea\"></div>");b.flush(this.$().get(0));b.destroy();};sap.ui.core.support.plugins.ControlTree.prototype.onsapUiSupportSelectorSelect=function(e){var c=e.getParameter("id");jQuery(".sapUiControlTreeElement > span").removeClass("sapUiSupportControlTreeSelected");var t=this;jQuery.sap.byId("sap-debug-controltree-"+c).parents("[data-sap-ui-collapsed]").each(function(b,v){t._onIconClick({srcElement:jQuery(v).find("img:first").get(0)});});var p=jQuery.sap.byId("sap-debug-controltree-"+c).children("span").addClass("sapUiSupportControlTreeSelected").position();var s=this.$().find("#sapUiSupportControlTreeArea").scrollTop();console.log(s+" - "+p.top);this.$().find("#sapUiSupportControlTreeArea").scrollTop(s+p.top);this._oStub.sendEvent("sapUiSupportRequestControlProperties",{id:c});};sap.ui.core.support.plugins.ControlTree.prototype._onNodeClick=function(e){var s=e.srcElement||e.target;var $=jQuery(s).closest("li");if($.hasClass("sapUiControlTreeElement")){jQuery(".sapUiControlTreeElement > span").removeClass("sapUiSupportControlTreeSelected");$.children("span").addClass("sapUiSupportControlTreeSelected");this._oStub.sendEvent("sapUiSupportSelectorHighlight",{id:$.attr("id").substring("sap-debug-controltree-".length)});this._oStub.sendEvent("sapUiSupportRequestControlProperties",{id:$.attr("id").substring("sap-debug-controltree-".length)});}e.stopPropagation();};sap.ui.core.support.plugins.ControlTree.prototype._onIconClick=function(e){var s=e.srcElement||e.target;var $=jQuery(s);if($.parent().attr("data-sap-ui-collapsed")){$.attr("src",$.attr("src").replace("plus","minus")).parent().removeAttr("data-sap-ui-collapsed");$.siblings("ul").show();}else{$.attr("src",$.attr("src").replace("minus","plus")).parent().attr("data-sap-ui-collapsed","true");$.siblings("ul").hide();}if(e.stopPropagation){e.stopPropagation();}};sap.ui.core.support.plugins.ControlTree.prototype.onsapUiSupportRequestControlProperties=function(e){var p=/^((boolean|string|int|float)(\[\])?)$/;var c=[];var o=sap.ui.getCore().byId(e.getParameter("id"));if(!o&&sap.ui.getCore().getUIArea(e.getParameter("id"))){c.push({control:"sap.ui.core.UIArea",properties:[],aggregations:[]});}else if(o){var m=o.getMetadata();while(m instanceof sap.ui.core.ElementMetadata){var b={control:m.getName(),properties:[],aggregations:[]};var d=m.getProperties();jQuery.each(d,function(k,g){var h={};jQuery.each(g,function(n,v){if(n.substring(0,1)!=="_"){h[n]=v;}var t=sap.ui.base.DataType.getType(g.type);if(t&&!(t instanceof sap.ui.base.DataType)){h["enumValues"]=t;}});h.value=o.getProperty(k);b.properties.push(h);});var f=m.getAggregations();jQuery.each(f,function(k,g){if(g.altTypes&&g.altTypes[0]&&p.test(g.altTypes[0])){var h={};jQuery.each(g,function(n,v){if(n.substring(0,1)!=="_"){h[n]=v;}});h.value=o.getAggregation(k);b.aggregations.push(h);}});c.push(b);m=m.getParent();}}this._oStub.sendEvent("sapUiSupportControlProperties",{id:e.getParameter("id"),properties:JSON.stringify(c)});};sap.ui.core.support.plugins.ControlTree.prototype.onsapUiSupportControlProperties=function(e){var c=JSON.parse(e.getParameter("properties"));var r=sap.ui.getCore().createRenderManager();r.write("<ul data-sap-ui-controlid='"+e.getParameter("id")+"'>");jQuery.each(c,function(b,v){r.write("<li>");r.write("<span><label class='sapUiSupportLabel'>BaseType:</label> <code>"+v.control+"</code></span>");if(v.properties.length>0||v.aggregations.length>0){r.write("<div class=\"sapUiSupportControlProperties\"><table><colgroup><col width=\"50%\"/><col width=\"50%\"/></colgroup>");jQuery.each(v.properties,function(b,p){r.write("<tr><td>");r.write("&nbsp;&nbsp;<label class='sapUiSupportLabel'>"+p.name+"</label>");r.write("</td><td>");if(p.type==="boolean"){r.write("<input type='checkbox' ");r.write("data-sap-ui-name='"+p.name+"' ");if(p.value==true){r.write("checked='checked'");}r.write("/>");}else if(p.enumValues){r.write("<div><select ");r.write("data-sap-ui-name='"+p.name+"'>");jQuery.each(p.enumValues,function(k,s){r.write("<option>");r.writeEscaped(k);r.write("</option>");});r.write("</select></div>");}else{r.write("<div><input type='text' ");r.write("data-sap-ui-name='"+p.name+"' ");if(p.value){r.write("value='");r.writeEscaped(""+p.value);r.write("'");}r.write("/></div>");}r.write("</td></tr>");});jQuery.each(v.aggregations,function(b,o){r.write("<tr><td>");r.write("&nbsp;&nbsp;<label class='sapUiSupportLabel'>"+o.name+"</label>");r.write("</td><td>");r.write(jQuery.sap.encodeHTML(""+o.value));r.write("</td></tr>");});r.write("</table></div>");}r.write("</li>");});r.write("</ul>");r.flush(this.$().find("#sapUiSupportControlPropertiesArea").get(0));r.destroy();};sap.ui.core.support.plugins.ControlTree.prototype._onPropertyChange=function(e){var s=e.srcElement||e.target;var $=jQuery(s);var b=$.closest("[data-sap-ui-controlid]").attr("data-sap-ui-controlid");var v=$.val();if($.attr("type")==="checkbox"){v=""+$.is(":checked");}this._oStub.sendEvent("sapUiSupportControlPropertyChange",{id:b,name:$.attr("data-sap-ui-name"),value:v});};sap.ui.core.support.plugins.ControlTree.prototype.onsapUiSupportControlPropertyChange=function(e){var s=e.getParameter("id");var c=sap.ui.getCore().byId(s);if(c){var n=e.getParameter("name");var v=e.getParameter("value");var m=c.getMetadata();m.getJSONKeys();var p=c.getMetadata().getAllProperties()[n];if(p&&p.type){var t=sap.ui.base.DataType.getType(p.type);if(t instanceof sap.ui.base.DataType){var b=t.parseValue(v);if(t.isValid(b)&&b!=="(null)"){c[p._sMutator](b);}}else if(t){if(t[v]){c[p._sMutator](v);}}}}};}());
